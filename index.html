<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>FinanceMax Platinum</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' } },
                    animation: { 'fade': 'fadeIn 0.3s ease', 'up': 'slideUp 0.3s ease' },
                    keyframes: { 
                        fadeIn: { '0%': {opacity:0}, '100%': {opacity:1} }, 
                        slideUp: { '0%': {transform:'translateY(20px)', opacity:0}, '100%': {transform:'translateY(0)', opacity:1} } 
                    }
                }
            }
        }
    </script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .dark .glass { background: rgba(15, 23, 42, 0.6); }
        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .input-field { width: 100%; padding: 1rem; border-radius: 1rem; background-color: #f8fafc; outline: none; border: 1px solid transparent; transition: all 0.2s; }
        .dark .input-field { background-color: #1e293b; color: white; }
        .input-field:focus { box-shadow: 0 0 0 2px #6366f1; background-color: white; }
        .dark .input-field:focus { background-color: #0f172a; }
        
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-weight: bold; border-radius: 1rem; padding: 1rem; transition: transform 0.1s; width: 100%; }
        .btn-primary:active { transform: scale(0.98); }
        .icon-btn { padding: 0.5rem; border-radius: 9999px; background-color: #f1f5f9; color: #64748b; transition: all; }
        .dark .icon-btn { background-color: #1e293b; color: #94a3b8; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 font-sans h-screen w-screen overflow-hidden selection:bg-indigo-500 selection:text-white">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        // ==========================================
        // ðŸ”´ PASTE YOUR WEB APP URL HERE ðŸ”´
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyjGxSVsB-qpx1MB6XU9GfYHxlSKDzou2rLd1PXZq5jd4Y_TrRcR_6J9BgjGEFCZ3g/exec"; 
        // ==========================================

        const { useState, useEffect, useMemo } = React;
        const { AreaChart, Area, ResponsiveContainer, Tooltip } = window.Recharts || {};

        // --- FIXED CURRENCY FORMATTER (Uses Browser API instead of hardcoded symbol) ---
        const formatMoney = (val) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0 // Keeps numbers clean (â‚¹500 instead of â‚¹500.00)
            }).format(val || 0);
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                };
                reader.onerror = (error) => reject(error);
            });
        };

        function Avatar({ imageId, name, size="md", selected, onClick }) {
            const [error, setError] = useState(false);
            const dims = size==='lg'?'w-24 h-24 text-4xl':size==='sm'?'w-8 h-8 text-xs':'w-12 h-12 text-base';
            const url = imageId ? `https://drive.google.com/thumbnail?id=${imageId}&sz=w400` : null;
            return (
                <div onClick={onClick} className={`shrink-0 rounded-full flex items-center justify-center overflow-hidden border-2 cursor-pointer transition-all ${dims} ${selected ? 'border-indigo-500 ring-4 ring-indigo-500/30 scale-105' : 'border-slate-200 dark:border-slate-700'} ${(!url || error) && 'bg-gradient-to-br from-indigo-100 to-indigo-50 text-indigo-600 dark:from-slate-800 dark:to-slate-900 dark:text-slate-400'}`}>
                    {url && !error ? <img src={url} className="w-full h-full object-cover" onError={() => setError(true)} referrerPolicy="no-referrer" /> : <span className="font-bold">{name?name[0].toUpperCase():'?'}</span>}
                </div>
            );
        }

        function Auth({ onLogin }) {
            const [view, setView] = useState('login');
            const [form, setForm] = useState({ email: '', password: '', username: '' });
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState(null);

            const submit = async (e) => {
                e.preventDefault(); setLoading(true); setMsg(null);
                try {
                    const url = view === 'login' ? `${API_URL}?action=login&email=${form.email}&password=${form.password}` : API_URL;
                    const opts = view === 'login' ? {} : { method: 'POST', body: JSON.stringify({ action: view, ...form }) };
                    const res = await fetch(url, opts);
                    const json = await res.json();
                    if(json.success) {
                        if(view === 'login') onLogin(json.user);
                        else { setMsg({type:'s', text:'Success! Login now.'}); setView('login'); }
                    } else setMsg({type:'e', text: json.error});
                } catch(e) { setMsg({type:'e', text: "Connection Error"}); }
                setLoading(false);
            };

            return (
                <div className="h-full flex items-center justify-center p-6 bg-slate-100 dark:bg-slate-900">
                    <div className="w-full max-w-sm bg-white dark:bg-slate-950 p-8 rounded-[2rem] shadow-2xl animate-up">
                        <h1 className="text-3xl font-bold text-center mb-2">FinanceMax</h1>
                        {msg && <div className={`p-3 rounded-xl text-center text-sm mb-4 font-bold ${msg.type==='e'?'bg-red-50 text-red-500':'bg-emerald-50 text-emerald-600'}`}>{msg.text}</div>}
                        <form onSubmit={submit} className="space-y-4 mt-6">
                            {view==='signup' && <input className="input-field" placeholder="Username" value={form.username} onChange={e=>setForm({...form, username:e.target.value})} required />}
                            <input className="input-field" placeholder="Email" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required />
                            <input type="password" className="input-field" placeholder="Password" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} required />
                            <button disabled={loading} className="btn-primary shadow-xl shadow-indigo-500/30">{loading ? <div className="loader mx-auto"></div> : (view==='login'?'Login':'Sign Up')}</button>
                        </form>
                        <button onClick={()=>setView(view==='login'?'signup':'login')} className="w-full mt-6 text-sm text-slate-400 hover:text-indigo-500">{view==='login'?'Create Account':'Back to Login'}</button>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, onLogout }) {
            const [data, setData] = useState({ transactions: [], people: [] });
            const [view, setView] = useState('home'); 
            const [loading, setLoading] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [modal, setModal] = useState(null); 
            const [editItem, setEditItem] = useState(null); 
            const [currentUser, setCurrentUser] = useState(user);

            useEffect(() => {
                if(darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                fetchData();
            }, [darkMode]);

            useEffect(() => { setTimeout(() => lucide.createIcons(), 200); }, [view, modal, data]);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}?action=getData&userId=${currentUser.id}`);
                    const json = await res.json();
                    if(json.success) {
                        setData({ transactions: json.transactions, people: json.people });
                        if(json.userProfile) setCurrentUser(json.userProfile);
                    }
                } catch(e) {}
                setLoading(false);
            };

            const openEdit = (item) => { setEditItem(item); setModal('add'); };

            const stats = useMemo(() => {
                let cashBal=0, onlineBal=0, rented=0, taken=0;
                const graph = {};
                
                data.transactions.forEach(t => {
                    const amt = t.amount;
                    if(t.type === 'income') t.paymentMode === 'Cash' ? cashBal += amt : onlineBal += amt;
                    if(t.type === 'expense') t.paymentMode === 'Cash' ? cashBal -= amt : onlineBal -= amt;
                    if(t.type === 'borrowed') { taken += amt; t.paymentMode === 'Cash' ? cashBal += amt : onlineBal += amt; }
                    if(t.type === 'lent') { rented += amt; t.paymentMode === 'Cash' ? cashBal -= amt : onlineBal -= amt; }
                    if(t.type === 'repayment_in') { rented -= amt; t.paymentMode === 'Cash' ? cashBal += amt : onlineBal += amt; }
                    if(t.type === 'repayment_out') { taken -= amt; t.paymentMode === 'Cash' ? cashBal -= amt : onlineBal -= amt; }

                    const d = t.date.split('T')[0];
                    if(!graph[d]) graph[d] = {date:d, val:0};
                    if(['income','borrowed','repayment_in'].includes(t.type)) graph[d].val+=amt; else graph[d].val-=amt;
                });

                const peopleStats = data.people.map(p => {
                    let net = 0;
                    data.transactions.filter(t => t.relatedPerson == p.id).forEach(t => {
                        if(t.type === 'lent') net += t.amount;
                        if(t.type === 'repayment_in') net -= t.amount;
                        if(t.type === 'borrowed') net -= t.amount;
                        if(t.type === 'repayment_out') net += t.amount;
                    });
                    return { ...p, net };
                });

                return { cashBal, onlineBal, total: cashBal+onlineBal, rented, taken, graph: Object.values(graph).sort((a,b)=>new Date(a.date)-new Date(b.date)), peopleStats };
            }, [data.transactions]);

            return (
                <div className="h-full w-full flex flex-col bg-slate-50 dark:bg-slate-950">
                    <header className="px-6 py-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center z-20">
                        <div className="flex items-center gap-3">
                            <Avatar imageId={currentUser.imageId} name={currentUser.name} />
                            <div><h1 className="font-bold dark:text-white leading-tight">Hi, {currentUser.name.split(' ')[0]}</h1></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setDarkMode(!darkMode)} className="icon-btn"><i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5"></i></button>
                            <button onClick={onLogout} className="icon-btn text-red-500 bg-red-50 dark:bg-red-900/20"><i data-lucide="log-out" className="w-5 h-5"></i></button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-6">
                        {view === 'home' && (
                            <div className="space-y-6 animate-fade">
                                <div className="glass p-6 rounded-[2rem] bg-gradient-to-br from-indigo-600 to-purple-700 text-white shadow-xl shadow-indigo-500/30">
                                    <p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Total Actual Balance</p>
                                    <h2 className="text-4xl font-bold">{formatMoney(stats.total)}</h2>
                                    <div className="mt-6 flex gap-3">
                                        <div className="bg-white/10 px-4 py-2 rounded-xl border border-white/10 backdrop-blur-md flex-1"><p className="text-[10px] text-emerald-300 font-bold uppercase">Online</p><p className="font-bold text-lg">{formatMoney(stats.onlineBal)}</p></div>
                                        <div className="bg-white/10 px-4 py-2 rounded-xl border border-white/10 backdrop-blur-md flex-1"><p className="text-[10px] text-emerald-300 font-bold uppercase">Cash</p><p className="font-bold text-lg">{formatMoney(stats.cashBal)}</p></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] shadow-sm"><p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Money Rented</p><p className="text-xl font-bold text-blue-500">{formatMoney(stats.rented)}</p><p className="text-[10px] text-slate-400 mt-1">People owe you</p></div>
                                    <div className="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] shadow-sm"><p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Money Taken</p><p className="text-xl font-bold text-amber-500">{formatMoney(stats.taken)}</p><p className="text-[10px] text-slate-400 mt-1">You owe</p></div>
                                </div>
                                <div className="h-56 bg-white dark:bg-slate-900 rounded-[2rem] p-4 shadow-sm border border-slate-200 dark:border-slate-800">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 ml-2">Cashflow Trend</p>
                                    {window.Recharts ? (
                                        <ResponsiveContainer><AreaChart data={stats.graph}><defs><linearGradient id="c" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs><Tooltip contentStyle={{backgroundColor:'#0f172a', border:'none', borderRadius:'12px', color:'#fff'}} /><Area type="monotone" dataKey="val" stroke="#6366f1" fill="url(#c)" strokeWidth={3} /></AreaChart></ResponsiveContainer>
                                    ) : <div className="flex justify-center items-center h-full text-slate-400">Loading Chart...</div>}
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-4 animate-fade">
                                <h2 className="text-xl font-bold dark:text-white px-2">Transactions</h2>
                                <p className="text-xs text-slate-400 px-2">Tap any item to edit or delete</p>
                                {data.transactions.map(t => (
                                    <div key={t.id} onClick={() => openEdit(t)} className="flex justify-between items-center p-4 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                                        <div className="flex gap-4 items-center">
                                            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-xl shrink-0 ${t.type.includes('income')?'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20':t.type.includes('expense')?'bg-red-50 text-red-600 dark:bg-red-900/20':'bg-blue-50 text-blue-600 dark:bg-blue-900/20'}`}>
                                                <i data-lucide={t.type==='income'?'arrow-down':t.type==='expense'?'arrow-up':'refresh-cw'} className="w-5 h-5"></i>
                                            </div>
                                            <div className="min-w-0">
                                                <p className="font-bold text-sm dark:text-white truncate">{t.category}</p>
                                                <div className="flex items-center gap-1">
                                                    <p className="text-xs text-slate-500 font-medium">{t.date.split('T')[0]} â€¢ {t.paymentMode}</p>
                                                    {t.imageId && <i data-lucide="paperclip" className="w-3 h-3 text-indigo-500"></i>}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right shrink-0">
                                            <span className="font-bold block dark:text-white text-lg">{formatMoney(t.amount)}</span>
                                            <span className="text-[10px] font-bold uppercase text-slate-400">{t.type==='income'?'In':t.type==='expense'?'Out':t.type==='borrowed'?'Debt':'Lent'}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'people' && (
                            <div className="space-y-4 animate-fade">
                                <div className="flex justify-between items-center px-2">
                                    <h2 className="text-xl font-bold dark:text-white">Friends</h2>
                                    <button onClick={()=>{setEditItem(null); setModal('person');}} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/30">+ Add Friend</button>
                                </div>
                                {stats.peopleStats.map(p => (
                                    <div key={p.id} className="flex items-center justify-between p-4 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <Avatar imageId={p.imageId} name={p.name} />
                                            <div>
                                                <p className="font-bold dark:text-white">{p.name}</p>
                                                <p className={`text-xs font-bold ${p.net > 0 ? 'text-emerald-500' : p.net < 0 ? 'text-red-500' : 'text-slate-400'}`}>
                                                    {p.net > 0 ? `He will give ${formatMoney(p.net)}` : p.net < 0 ? `You will give ${formatMoney(Math.abs(p.net))}` : 'Settled'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'profile' && <ProfileView user={currentUser} onUpdate={u => setCurrentUser(u)} />}
                    </div>

                    <button onClick={()=>{setEditItem(null); setModal('add');}} className="absolute bottom-24 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-xl shadow-indigo-500/40 flex items-center justify-center z-30 transition-transform active:scale-90"><i data-lucide="plus" className="w-8 h-8"></i></button>

                    <div className="absolute bottom-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 px-6 py-3 flex justify-between items-center z-40 pb-safe">
                        {['home','history','people','profile'].map(v => (
                            <button key={v} onClick={()=>setView(v)} className={`flex flex-col items-center gap-1 transition-all ${view===v?'text-indigo-600 scale-110':'text-slate-400 dark:text-slate-600'}`}>
                                <i data-lucide={v==='home'?'home':v==='history'?'list':v==='people'?'users':'user'} className={`w-6 h-6 ${view===v && 'fill-indigo-500/10'}`}></i>
                            </button>
                        ))}
                    </div>

                    {modal === 'add' && <TransactionModal user={currentUser} people={data.people} editItem={editItem} onClose={()=>{setModal(null); fetchData();}} />}
                    {modal === 'person' && <PersonModal user={currentUser} onClose={()=>{setModal(null); fetchData();}} />}
                </div>
            );
        }

        // --- UPDATED TRANSACTION MODAL (MULTI-SPLIT) ---
        function TransactionModal({ user, people, editItem, onClose }) {
            const [tab, setTab] = useState(editItem ? 'simple' : 'simple'); 
            const [splitMode, setSplitMode] = useState('equal');
            const [includeMe, setIncludeMe] = useState(true);
            const [selectedFriends, setSelectedFriends] = useState([]); 
            const [splitAmounts, setSplitAmounts] = useState({}); 

            const [form, setForm] = useState(editItem ? {
                type: editItem.type,
                amount: editItem.amount,
                category: editItem.category,
                description: editItem.description,
                date: editItem.date.split('T')[0],
                relatedPerson: editItem.relatedPerson || '',
                paymentMode: editItem.paymentMode || 'Online',
                totalBill: ''
            } : { 
                type: 'expense', amount: '', category: 'General', description: '', 
                date: new Date().toISOString().split('T')[0], relatedPerson: '', 
                paymentMode: 'Online', totalBill: ''
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if(editItem) {
                    if(['lent','borrowed','repayment_in','repayment_out'].includes(editItem.type)) setTab('friend');
                    else setTab('simple');
                }
            }, [editItem]);

            // Split Logic
            useEffect(() => {
                if(tab === 'split' && splitMode === 'equal' && form.totalBill) {
                    const total = parseFloat(form.totalBill) || 0;
                    const participants = [...selectedFriends];
                    if(includeMe) participants.push('me');
                    const count = participants.length;
                    
                    if(count > 0) {
                        const share = parseFloat((total / count).toFixed(2));
                        const newSplits = {};
                        selectedFriends.forEach(id => newSplits[id] = share);
                        if(includeMe) newSplits['me'] = share;
                        setSplitAmounts(newSplits);
                    }
                }
            }, [form.totalBill, selectedFriends, includeMe, splitMode, tab]);

            const toggleFriend = (id) => {
                if(selectedFriends.includes(id)) setSelectedFriends(prev => prev.filter(f => f !== id));
                else setSelectedFriends(prev => [...prev, id]);
            };

            const handleImage = (e) => {
                const file = e.target.files[0];
                if(file) compressImage(file).then(b64 => setForm({...form, imageBase64: b64}));
            };

            const submit = async (e) => {
                e.preventDefault(); setLoading(true);
                let body = {};
                
                if(tab === 'split') {
                    const items = [];
                    if(includeMe && splitAmounts['me'] > 0) {
                        items.push({ ...form, type: 'expense', amount: parseFloat(splitAmounts['me']), description: `${form.description} (My Share)`, relatedPerson: '' });
                    }
                    selectedFriends.forEach(id => {
                        if(splitAmounts[id] > 0) {
                            items.push({ ...form, type: 'lent', amount: parseFloat(splitAmounts[id]), description: `${form.description} (Lent)`, relatedPerson: id });
                        }
                    });
                    
                    if(items.length === 0) { alert("Invalid split"); setLoading(false); return; }
                    body = { action: 'batchAdd', userId: user.id, items };
                } else {
                    body = { action: editItem ? 'update' : 'add', id: editItem ? editItem.id : undefined, userId: user.id, ...form };
                }

                await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
                onClose();
            };

            const handleDelete = async () => {
                if(!confirm("Delete this?")) return;
                setLoading(true);
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: editItem.id, userId: user.id }) });
                onClose();
            };

            const remaining = (parseFloat(form.totalBill)||0) - Object.values(splitAmounts).reduce((a,b) => a + (parseFloat(b)||0), 0);

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-slate-900/60 backdrop-blur-sm p-2 sm:items-center">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2rem] p-6 shadow-2xl animate-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-xl dark:text-white">{editItem ? 'Edit Entry' : 'New Entry'}</h3>
                            <button onClick={onClose} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><i data-lucide="x" className="w-5 h-5"></i></button>
                        </div>

                        {!editItem && <div className="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-2xl mb-6">
                            {['simple', 'friend', 'split'].map(t => (
                                <button key={t} onClick={()=>setTab(t)} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wider rounded-xl transition-all ${tab===t?'bg-white dark:bg-slate-700 shadow text-indigo-500':'text-slate-400'}`}>{t}</button>
                            ))}
                        </div>}

                        <form onSubmit={submit} className="space-y-5">
                            {/* SIMPLE MODE */}
                            {tab === 'simple' && (
                                <div className="flex gap-3">
                                    <button type="button" onClick={()=>setForm({...form, type:'income'})} className={`flex-1 py-4 rounded-2xl border-2 font-bold transition-all ${form.type==='income'?'border-emerald-500 bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20':'border-transparent bg-slate-50 dark:bg-slate-800 text-slate-500'}`}>Money In</button>
                                    <button type="button" onClick={()=>setForm({...form, type:'expense'})} className={`flex-1 py-4 rounded-2xl border-2 font-bold transition-all ${form.type==='expense'?'border-red-500 bg-red-50 text-red-600 dark:bg-red-900/20':'border-transparent bg-slate-50 dark:bg-slate-800 text-slate-500'}`}>Money Out</button>
                                </div>
                            )}

                            {/* SPLIT BILL MODE */}
                            {tab === 'split' && (
                                <div className="space-y-4">
                                    <div className="flex gap-2 mb-2">
                                        <button type="button" onClick={()=>setSplitMode('equal')} className={`flex-1 py-2 text-xs font-bold rounded-lg border ${splitMode==='equal'?'border-indigo-500 text-indigo-500 bg-indigo-50 dark:bg-indigo-900/20':'border-slate-200 text-slate-400'}`}>Equal</button>
                                        <button type="button" onClick={()=>setSplitMode('custom')} className={`flex-1 py-2 text-xs font-bold rounded-lg border ${splitMode==='custom'?'border-indigo-500 text-indigo-500 bg-indigo-50 dark:bg-indigo-900/20':'border-slate-200 text-slate-400'}`}>Custom</button>
                                    </div>
                                    
                                    <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-900/50">
                                        <p className="text-xs font-bold text-indigo-400 uppercase mb-2">Total Bill</p>
                                        <input type="number" placeholder="â‚¹0" className="w-full bg-transparent text-3xl font-bold text-indigo-600 dark:text-indigo-400 outline-none" value={form.totalBill} onChange={e => setForm({...form, totalBill: e.target.value})} />
                                    </div>

                                    {splitMode === 'custom' && Math.abs(remaining) > 0.1 && (
                                        <div className={`text-xs text-center font-bold ${remaining < 0 ? 'text-red-500' : 'text-slate-400'}`}>
                                            {remaining > 0 ? `Remaining: ${formatMoney(remaining)}` : `Over by: ${formatMoney(Math.abs(remaining))}`}
                                        </div>
                                    )}

                                    <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                                        <div className={`w-5 h-5 rounded border flex items-center justify-center cursor-pointer ${includeMe ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-slate-300'}`} onClick={()=>setIncludeMe(!includeMe)}>
                                            {includeMe && <i data-lucide="check" className="w-3 h-3"></i>}
                                        </div>
                                        <div className="flex-1 text-sm font-bold dark:text-white">Include Me</div>
                                        {includeMe && (
                                            <input 
                                                type="number" 
                                                className="w-20 p-2 text-right bg-transparent outline-none font-bold" 
                                                placeholder="0"
                                                value={splitAmounts['me'] || ''}
                                                disabled={splitMode === 'equal'}
                                                onChange={e => setSplitAmounts({...splitAmounts, me: e.target.value})}
                                            />
                                        )}
                                    </div>

                                    <div className="space-y-2 max-h-40 overflow-y-auto hide-scroll">
                                        {people.map(p => (
                                            <div key={p.id} className={`flex items-center gap-3 p-3 rounded-xl border transition-all ${selectedFriends.includes(p.id) ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : 'border-slate-200 dark:border-slate-800'}`}>
                                                <div onClick={()=>toggleFriend(p.id)} className="cursor-pointer">
                                                    <Avatar imageId={p.imageId} name={p.name} size="sm" selected={selectedFriends.includes(p.id)} />
                                                </div>
                                                <div className="flex-1 text-sm font-bold dark:text-white cursor-pointer" onClick={()=>toggleFriend(p.id)}>{p.name}</div>
                                                {selectedFriends.includes(p.id) && (
                                                    <input 
                                                        type="number" 
                                                        className="w-20 p-2 text-right bg-transparent outline-none font-bold" 
                                                        placeholder="0"
                                                        value={splitAmounts[p.id] || ''}
                                                        disabled={splitMode === 'equal'}
                                                        onChange={e => setSplitAmounts({...splitAmounts, [p.id]: e.target.value})}
                                                    />
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* FRIEND/DEBT MODE */}
                            {tab === 'friend' && (
                                <>
                                    <select className="input-field" value={form.type} onChange={e=>setForm({...form, type:e.target.value})}>
                                        <option value="lent">Money Rented (I gave)</option>
                                        <option value="borrowed">Money Taken (I took)</option>
                                        <option value="repayment_in">He Paid Back</option>
                                        <option value="repayment_out">I Paid Back</option>
                                    </select>
                                    <div className="flex gap-4 overflow-x-auto pb-2 hide-scroll">
                                        {people.map(p => (
                                            <div key={p.id} onClick={()=>setForm({...form, relatedPerson: p.id})} className="flex flex-col items-center gap-2 cursor-pointer group">
                                                <Avatar imageId={p.imageId} name={p.name} selected={form.relatedPerson === p.id} />
                                                <span className={`text-[10px] font-bold ${form.relatedPerson === p.id ? 'text-indigo-500':'text-slate-500'}`}>{p.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}

                            <div className="flex gap-2">
                                <button type="button" onClick={()=>setForm({...form, paymentMode:'Online'})} className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all ${form.paymentMode==='Online'?'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30':'bg-slate-100 dark:bg-slate-800 dark:text-slate-400'}`}>Online</button>
                                <button type="button" onClick={()=>setForm({...form, paymentMode:'Cash'})} className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all ${form.paymentMode==='Cash'?'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30':'bg-slate-100 dark:bg-slate-800 dark:text-slate-400'}`}>Cash</button>
                            </div>

                            {tab !== 'split' && <input type="number" placeholder="Amount" className="input-field text-xl font-bold" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} required />}
                            <input className="input-field" placeholder="Category" value={form.category} onChange={e=>setForm({...form, category:e.target.value})} required />
                            
                            <label className="flex items-center gap-3 p-3 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${form.imageBase64 ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>
                                    <i data-lucide={form.imageBase64 ? 'check' : 'camera'}></i>
                                </div>
                                <span className="text-sm text-slate-500">{form.imageBase64 ? 'Receipt Attached' : 'Attach Receipt'}</span>
                                <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                            </label>

                            <input className="input-field" type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required />
                            
                            <button disabled={loading} className="btn-primary shadow-xl shadow-indigo-500/30 text-lg">{loading ? 'Saving...' : 'Save'}</button>
                            {editItem && <button type="button" onClick={handleDelete} className="w-full py-3 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-xl">Delete Entry</button>}
                        </form>
                    </div>
                </div>
            );
        }

        // --- MODAL: ADD PERSON ---
        function PersonModal({ user, onClose }) {
            const [form, setForm] = useState({ name: '', phone: '', imageBase64: '' });
            const [loading, setLoading] = useState(false);
            
            const handleImage = (e) => {
                const file = e.target.files[0];
                if(file) compressImage(file).then(b64 => setForm({...form, imageBase64: b64}));
            };

            const submit = async (e) => {
                e.preventDefault(); setLoading(true);
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addPerson', userId: user.id, ...form }) });
                onClose();
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 animate-up shadow-2xl">
                        <h3 className="font-bold text-lg mb-6 dark:text-white">Add New Friend</h3>
                        <form onSubmit={submit} className="space-y-5">
                            <label className="block w-24 h-24 mx-auto rounded-full bg-slate-100 dark:bg-slate-800 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden cursor-pointer hover:bg-slate-200 transition">
                                {form.imageBase64 ? <img src={form.imageBase64} className="w-full h-full object-cover"/> : <i data-lucide="camera" className="text-slate-400 w-8 h-8"></i>}
                                <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                            </label>
                            <input className="input-field" placeholder="Full Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required />
                            <input className="input-field" placeholder="Phone (Optional)" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} />
                            <div className="flex gap-3 mt-4">
                                <button type="button" onClick={onClose} className="flex-1 py-3 text-slate-500 font-bold">Cancel</button>
                                <button disabled={loading} className="flex-1 btn-primary shadow-lg">{loading ? '...' : 'Add Friend'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- PROFILE VIEW ---
        function ProfileView({ user, onUpdate }) {
            const [form, setForm] = useState({ username: user.name, phone: user.phone, imageBase64: '' });
            const [loading, setLoading] = useState(false);
            
            const handleImage = (e) => {
                const file = e.target.files[0];
                if(file) compressImage(file).then(b64 => setForm({...form, imageBase64: b64}));
            };

            const save = async () => {
                setLoading(true);
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateProfile', userId: user.id, ...form }) });
                onUpdate({ ...user, name: form.username, phone: form.phone });
                setLoading(false); alert("Updated!");
            };
            return (
                <div className="animate-fade space-y-8 p-2">
                    <div className="flex flex-col items-center">
                        <label className="relative cursor-pointer group">
                            <Avatar imageId={user.imageId} name={user.name} size="lg" />
                            <div className="absolute bottom-0 right-0 bg-indigo-600 rounded-full p-1 text-white"><i data-lucide="camera" className="w-4 h-4"></i></div>
                            <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                        </label>
                    </div>
                    <input className="input-field" value={form.username} onChange={e=>setForm({...form, username:e.target.value})} placeholder="Name" />
                    <input className="input-field" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} placeholder="Phone" />
                    <button onClick={save} disabled={loading} className="btn-primary shadow-lg shadow-indigo-500/20">{loading?'...':'Update'}</button>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            
            useEffect(() => {
                const saved = localStorage.getItem('fm_plat_user');
                if(saved) setUser(JSON.parse(saved));
            }, []);

            const handleLogin = (u) => {
                setUser(u);
                localStorage.setItem('fm_plat_user', JSON.stringify(u));
            };
            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('fm_plat_user');
            };

            return user ? <Dashboard user={user} onLogout={handleLogout} /> : <Auth onLogin={handleLogin} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
