<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>FinanceMax Platinum | Financial Systems Edition</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' } },
                    animation: { 'fade': 'fadeIn 0.2s ease-out', 'up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)', 'spin-once': 'spin 0.5s linear' },
                    keyframes: {
                        fadeIn: { '0%': {opacity:0}, '100%': {opacity:1} },
                        slideUp: { '0%': {transform:'translateY(20px)', opacity:0}, '100%': {transform:'translateY(0)', opacity:1} }
                    }
                }
            }
        }
    </script>
   
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .dark .glass { background: rgba(15, 23, 42, 0.6); }
        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .input-field { width: 100%; padding: 1rem; border-radius: 1rem; background-color: #f8fafc; outline: none; border: 1px solid transparent; transition: all 0.2s; }
        .dark .input-field { background-color: #1e293b; color: white; }
        .input-field:focus { box-shadow: 0 0 0 2px var(--theme-color, #6366f1); background-color: white; }
        .dark .input-field:focus { background-color: #0f172a; }
        .btn-primary { color: white; font-weight: bold; border-radius: 1rem; padding: 1rem; transition: transform 0.1s; width: 100%; }
        .btn-primary:active { transform: scale(0.98); }
        .icon-btn { padding: 0.5rem; border-radius: 9999px; background-color: #f1f5f9; color: #64748b; transition: all; }
        .dark .icon-btn { background-color: #1e293b; color: #94a3b8; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .scroll-x { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        /* Financial state indicators */
        .state-pending { background-color: #fef3c7; color: #92400e; border-color: #fbbf24; }
        .dark .state-pending { background-color: #78350f; color: #fbbf24; }
        .state-approved { background-color: #d1fae5; color: #065f46; border-color: #10b981; }
        .dark .state-approved { background-color: #064e3b; color: #10b981; }
        .state-paid { background-color: #dbeafe; color: #1e40af; border-color: #3b82f6; }
        .dark .state-paid { background-color: #1e3a8a; color: #60a5fa; }
        .state-confirmed { background-color: #dcfce7; color: #166534; border-color: #22c55e; }
        .dark .state-confirmed { background-color: #14532d; color: #4ade80; }
        .state-rejected { background-color: #fee2e2; color: #991b1b; border-color: #ef4444; }
        .dark .state-rejected { background-color: #7f1d1d; color: #f87171; }
        /* Responsive modal helper classes */
        .modal-inner { max-width: calc(100% - 32px); box-sizing: border-box; padding: 1rem; border-radius: 1rem; }
        @media (min-width: 640px) { .modal-inner { max-width: 28rem; padding: 1.5rem; border-radius: 2rem; } }
        .wrap-break { word-break: break-word; overflow-wrap: anywhere; }
        .confirm-buttons { display: flex; gap: 0.75rem; }
        @media (max-width: 639px) { .confirm-buttons { flex-direction: column; } }
        /* Make inputs a bit tighter on small screens */
        .input-field { padding: 0.75rem; }
        @media (min-width: 640px) { .input-field { padding: 1rem; } }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 font-sans h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { AreaChart, Area, BarChart, Bar, PieChart, Pie, Cell, ResponsiveContainer, Tooltip, XAxis, YAxis, Legend, CartesianGrid } = window.Recharts || {};
        const COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
       
        // IMPORTANT: Replace this with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw1LbXM8fR8zOOnN6oYL4eOlJRL00pQfKECP_434foMY2Yh_8vuyLcSORNpuV1U31g/exec';
        
        // API Helper Functions - Fixed to work with Google Apps Script
        const api = {
            async call(action, data = {}, method = 'POST') {
                try {
                    const url = SCRIPT_URL;
                    
                    // For GET requests
                    if (method === 'GET') {
                        // Build URL with parameters
                        const params = new URLSearchParams();
                        params.append('action', action);
                        Object.keys(data).forEach(key => {
                            if (data[key] !== undefined && data[key] !== null) {
                                params.append(key, data[key]);
                            }
                        });
                        
                        const fullUrl = `${url}?${params.toString()}`;
                        const response = await fetch(fullUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const text = await response.text();
                        
                        // Handle JSONP responses
                        if (text.startsWith('jsonp_callback_')) {
                            const jsonStr = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                            return JSON.parse(jsonStr);
                        }
                        
                        return JSON.parse(text);
                    } else {
                        // For POST requests
                        const params = new URLSearchParams();
                        params.append('action', action);
                        Object.keys(data).forEach(key => {
                            if (data[key] !== undefined && data[key] !== null) {
                                params.append(key, data[key]);
                            }
                        });
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: params.toString()
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const text = await response.text();
                        return JSON.parse(text);
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    return { 
                        success: false, 
                        error: error.message.includes('NetworkError') || error.message.includes('Failed to fetch') 
                            ? 'Network error. Please check your connection.' 
                            : 'Server error: ' + error.message 
                    };
                }
            },

            // Auth
            async login(email, password) {
                return this.call('login', { email, password });
            },

            async signup(userData) {
                return this.call('signup', userData);
            },

            async verifyPhone(userId, phone, upiId) {
                return this.call('verifyPhone', { userId, phone, upiId });
            },

            // Profile
            async updateProfile(userId, updates) {
                return this.call('updateProfile', { userId, ...updates });
            },

            async updatePassword(userId, currentPassword, newPassword) {
                return this.call('updatePassword', { userId, currentPassword, newPassword });
            },

            // Transactions
            async createTransaction(transaction) {
                return this.call('createTransaction', transaction);
            },

            async updateTransaction(transactionId, updates) {
                return this.call('updateTransaction', { transactionId, ...updates });
            },

            async getTransactions(userId, filters = {}) {
                return this.call('getTransactions', { userId, ...filters }, 'GET');
            },

            async deleteTransaction(transactionId, userId) {
                return this.call('deleteTransaction', { transactionId, userId });
            },

            // Friends
            async searchUsers(query, currentUserId) {
                return this.call('searchUsers', { query, currentUserId }, 'GET');
            },

            async sendFriendRequest(senderId, receiverEmail) {
                return this.call('sendFriendRequest', { senderId, receiverEmail });
            },

            async respondToFriendRequest(requestId, accept) {
                return this.call('respondToFriendRequest', { requestId, accept: accept.toString() });
            },

            async getFriends(userId) {
                return this.call('getFriends', { userId }, 'GET');
            },

            // Notifications
            async getNotifications(userId) {
                return this.call('getNotifications', { userId }, 'GET');
            },

            async markNotificationRead(notificationId) {
                return this.call('markNotificationRead', { notificationId });
            },

            // Dashboard
            async getDashboardData(userId) {
                return this.call('getDashboardData', { userId }, 'GET');
            },

            // Categories
            async getCategories(userId) {
                return this.call('getCategories', { userId }, 'GET');
            },

            async addCategory(userId, category) {
                return this.call('addCategory', { userId, category });
            },

            // Initialize system
            async setupSystem() {
                return this.call('setup', {}, 'GET');
            }
        };

        // Image compression
        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader(); 
            reader.readAsDataURL(file);
            reader.onload = (e) => { 
                const img = new Image(); 
                img.src = e.target.result; 
                img.onload = () => { 
                    const canvas = document.createElement('canvas'); 
                    const scale = 600 / img.width; 
                    canvas.width = 600; 
                    canvas.height = img.height * scale; 
                    const ctx = canvas.getContext('2d'); 
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                }; 
            };
        });
        
        // Theme templates
        const THEMES = {
            indigo:  { bg: '#6366f1', class: 'bg-indigo-600',  text: 'text-indigo-600',  border: 'border-indigo-600' },
            emerald: { bg: '#10b981', class: 'bg-emerald-600', text: 'text-emerald-600', border: 'border-emerald-600' },
            rose:    { bg: '#e11d48', class: 'bg-rose-600',    text: 'text-rose-600',    border: 'border-rose-600' },
            amber:   { bg: '#f59e0b', class: 'bg-amber-600',   text: 'text-amber-600',   border: 'border-amber-600' },
            cyan:    { bg: '#06b6d4', class: 'bg-cyan-600',    text: 'text-cyan-600',    border: 'border-cyan-600' },
            teal:    { bg: '#14b8a6', class: 'bg-teal-600',    text: 'text-teal-600',    border: 'border-teal-600' },
            violet:  { bg: '#8b5cf6', class: 'bg-violet-600',  text: 'text-violet-600',  border: 'border-violet-600' },
            fuchsia: { bg: '#d946ef', class: 'bg-fuchsia-600', text: 'text-fuchsia-600', border: 'border-fuchsia-600' },
            pink:    { bg: '#ec4899', class: 'bg-pink-600',    text: 'text-pink-600',    border: 'border-pink-600' },
            lime:    { bg: '#84cc16', class: 'bg-lime-600',    text: 'text-lime-600',    border: 'border-lime-600' },
            yellow:  { bg: '#f59e0b', class: 'bg-yellow-500',  text: 'text-yellow-500',  border: 'border-yellow-500' },
            orange:  { bg: '#fb923c', class: 'bg-orange-500',  text: 'text-orange-500',  border: 'border-orange-500' },
            blue:    { bg: '#3b82f6', class: 'bg-blue-600',    text: 'text-blue-600',    border: 'border-blue-600' },
            gray:    { bg: '#6b7280', class: 'bg-gray-600',    text: 'text-gray-600',    border: 'border-gray-600' },
            slate:   { bg: '#0f172a', class: 'bg-slate-900',   text: 'text-slate-900',   border: 'border-slate-900' },
            sky:     { bg: '#0ea5e9', class: 'bg-sky-600',     text: 'text-sky-600',     border: 'border-sky-600' }
        };
        
        // Helper Functions
        const formatCurrency = (amount) => {
            return `₹${parseFloat(amount || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        const validatePhone = (phone) => {
            const phoneRegex = /^[6-9]\d{9}$/;
            return phoneRegex.test(phone);
        };

        const validateUPI = (upi) => {
            const upiRegex = /^[\w\.\-]{2,256}@[\w]{2,64}$/;
            return upiRegex.test(upi);
        };

        const validatePassword = (password) => {
            return password.length >= 6;
        };

        const getDateRange = (filter) => {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            switch(filter) {
                case 'TODAY':
                    return { start: now.toISOString().split('T')[0], end: now.toISOString().split('T')[0] };
                case 'YESTERDAY':
                    const yesterday = new Date(now.getTime() - 86400000);
                    return { start: yesterday.toISOString().split('T')[0], end: yesterday.toISOString().split('T')[0] };
                case '7':
                    const weekAgo = new Date(now.getTime() - 7 * 86400000);
                    return { start: weekAgo.toISOString().split('T')[0], end: now.toISOString().split('T')[0] };
                case '30':
                    const monthAgo = new Date(now.getTime() - 30 * 86400000);
                    return { start: monthAgo.toISOString().split('T')[0], end: now.toISOString().split('T')[0] };
                default:
                    return { start: null, end: null };
            }
        };

        function Avatar({ imageId, name, size = "md", theme }) {
            const [err, setErr] = useState(false);
            const dims = size === 'lg' ? 'w-24 h-24 text-4xl' : size === 'sm' ? 'w-8 h-8 text-xs' : 'w-12 h-12 text-base';
            const url = imageId ? `https://drive.google.com/thumbnail?id=${imageId}&sz=w400` : null;
            const borderColor = (THEMES[theme] && THEMES[theme].bg) || '#cbd5e1';
            return (
                <div className={`shrink-0 rounded-full flex items-center justify-center overflow-hidden ${dims} ${(!url || err) && 'bg-slate-100 dark:bg-slate-800'}`} 
                     style={{color: THEMES[theme] ? THEMES[theme].bg : undefined, borderColor: borderColor, borderStyle: 'solid', borderWidth: '1px'}}>
                    {url && !err ? 
                        <img loading="lazy" src={url} className="w-full h-full object-cover" onError={() => setErr(true)} alt={name || 'Avatar'}/> : 
                        <span className="font-bold">{name ? name[0].toUpperCase() : '?'}</span>
                    }
                </div>
            );
        }
        
        function ConfirmDialog({ isOpen, title, msg, onConfirm, onCancel, type = 'neutral', theme, single = false, confirmLabel = 'Confirm' }) {
            if(!isOpen) return null;
            const isDanger = type === 'danger';
            const iconBgStyle = isDanger ? { backgroundColor: '#fee2e2', color: '#ef4444' } : { backgroundColor: `${THEMES[theme].bg}20`, color: THEMES[theme].bg };
            const confirmBtnClass = isDanger ? 'bg-red-500 shadow-red-500/30' : `${THEMES[theme].class} shadow-lg`;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-fade">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onCancel}></div>
                    <div className="relative bg-white dark:bg-slate-900 w-full max-w-xs modal-inner shadow-2xl border border-slate-100 dark:border-slate-800 animate-up">
                        <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5" style={iconBgStyle}>
                            <i data-lucide={isDanger ? 'alert-triangle' : 'help-circle'} className="w-8 h-8"></i>
                        </div>
                        <h3 className="font-bold text-xl dark:text-white mb-2 text-center">{title}</h3>
                        <p className="text-slate-500 dark:text-slate-400 text-sm mb-8 text-center leading-relaxed wrap-break">{msg}</p>
                        <div className="confirm-buttons">
                            {!single && <button onClick={onCancel} className="flex-1 py-3.5 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>}
                            <button onClick={onConfirm} className={`flex-1 py-3.5 rounded-2xl font-bold text-sm text-white shadow-xl active:scale-95 transition-transform ${confirmBtnClass}`}>{confirmLabel}</button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function TransactionStateBadge({ status, theme, iconOnly = false, small = false }) {
            const stateConfig = {
                'Pending': { label: 'Pending', icon: 'clock', bg: 'bg-amber-100', fg: 'text-amber-600' },
                'Approved': { label: 'Approved', icon: 'check-circle', bg: 'bg-emerald-50', fg: 'text-emerald-600' },
                'Marked as Paid': { label: 'Paid', icon: 'check-circle', bg: 'bg-emerald-50', fg: 'text-emerald-600' },
                'Confirmed': { label: 'Confirmed', icon: 'check-circle', bg: 'bg-emerald-50', fg: 'text-emerald-600' },
                'Rejected': { label: 'Rejected', icon: 'x-circle', bg: 'bg-red-50', fg: 'text-red-600' },
                'Not Received': { label: 'Not Received', icon: 'alert-circle', bg: 'bg-red-50', fg: 'text-red-600' }
            };

            const config = stateConfig[status] || { label: status, icon: 'help-circle', bg: 'bg-slate-100', fg: 'text-slate-600' };

            if (iconOnly) {
                if (small) {
                    return (
                        <span title={config.label} className={`status-icon-small ${config.fg}`} role="img" aria-label={config.label}>
                            <i data-lucide={config.icon} className="w-3 h-3"></i>
                        </span>
                    );
                }
                return (
                    <span title={config.label} className={`status-icon-inline ${config.bg} ${config.fg}`} role="img" aria-label={config.label}>
                        <i data-lucide={config.icon} className="w-4 h-4"></i>
                    </span>
                );
            }

            return (
                <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold uppercase ${config.bg} ${config.fg}`}>
                    <i data-lucide={config.icon} className="w-3 h-3"></i>
                    {config.label}
                </span>
            );
        }
        
        // Phone and UPI Verification Modal
        function VerificationModal({ user, onComplete, onSkip, theme }) {
            const [phone, setPhone] = useState(user.phone || '');
            const [upiId, setUpiId] = useState(user.upiId || '');
            const [loading, setLoading] = useState(false);
            const [warnings, setWarnings] = useState([]);
            const [verified, setVerified] = useState(user.phoneVerified || false);

            useEffect(() => {
                if (verified) return;
                
                if (warnings.length === 0 && phone && upiId) {
                    if (!validatePhone(phone)) {
                        setWarnings(prev => [...prev, 'Phone number must be 10 digits starting with 6-9']);
                    }
                    if (!validateUPI(upiId)) {
                        setWarnings(prev => [...prev, 'Invalid UPI ID format (e.g., name@upi)']);
                    }
                    if (warnings.length === 0 && phone && upiId) {
                        setWarnings(prev => ['⚠️ Please verify your phone and UPI details are correct']);
                    }
                }
            }, [phone, upiId, warnings.length, verified]);

            const handleSubmit = async () => {
                if (verified) {
                    onComplete();
                    return;
                }

                if (!validatePhone(phone)) {
                    alert('Please enter a valid 10-digit phone number');
                    return;
                }

                if (!validateUPI(upiId)) {
                    alert('Please enter a valid UPI ID (e.g., name@upi)');
                    return;
                }

                setLoading(true);
                const result = await api.verifyPhone(user.id, phone, upiId);
                setLoading(false);

                if (result.success) {
                    setVerified(true);
                    if (result.data && result.data.user) {
                        localStorage.setItem('fm_plat_user', JSON.stringify(result.data.user));
                    }
                    setTimeout(() => onComplete(), 1000);
                } else {
                    alert(result.error || 'Verification failed');
                }
            };

            if (verified) {
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                        <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 animate-up shadow-2xl text-center">
                            <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="check-circle" className="w-8 h-8"></i>
                            </div>
                            <h3 className="font-bold text-xl dark:text-white mb-2">Already Verified!</h3>
                            <p className="text-slate-500 mb-6">Your phone and UPI are already verified.</p>
                            <button onClick={onComplete} className={`w-full py-3 rounded-xl text-white font-bold ${THEMES[theme].class}`}>
                                Continue to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 animate-up shadow-2xl">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="shield" className="w-8 h-8"></i>
                            </div>
                            <h3 className="font-bold text-xl dark:text-white mb-2">Complete Your Profile</h3>
                            <p className="text-slate-500">Add your phone number and UPI ID for transactions</p>
                        </div>

                        <div className="space-y-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Phone Number</label>
                                <input
                                    type="tel"
                                    className="input-field"
                                    placeholder="10-digit mobile number"
                                    value={phone}
                                    onChange={(e) => setPhone(e.target.value.replace(/\D/g, '').slice(0, 10))}
                                    maxLength="10"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">UPI ID</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    placeholder="name@upi"
                                    value={upiId}
                                    onChange={(e) => setUpiId(e.target.value)}
                                />
                            </div>
                        </div>

                        {warnings.length > 0 && (
                            <div className="mb-6 space-y-2">
                                {warnings.map((warning, idx) => (
                                    <div key={idx} className="p-3 bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-300 rounded-lg text-sm">
                                        {warning}
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="space-y-3">
                            <button 
                                onClick={handleSubmit} 
                                disabled={loading}
                                className={`w-full py-3 rounded-xl text-white font-bold ${THEMES[theme].class} ${loading ? 'opacity-50' : ''}`}
                            >
                                {loading ? 'Verifying...' : 'Verify & Continue'}
                            </button>
                            <button 
                                onClick={onSkip}
                                className="w-full py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold"
                            >
                                Skip for Now
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Enhanced Profile View
        function EnhancedProfileView({ user, onUpdate, theme, setTheme, setAccentColor, onLogout }) {
            const [activeTab, setActiveTab] = useState('profile');
            const [form, setForm] = useState({ 
                username: user.name, 
                phone: user.phone, 
                email: user.email,
                upiId: user.upiId || '',
                imageBase64: '' 
            });
            const [securityForm, setSecurityForm] = useState({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);

            const handleImage = (e) => { 
                const file = e.target.files[0]; 
                if(file) compressImage(file).then(b64 => setForm({...form, imageBase64: b64})); 
            };

            const saveProfile = async () => {
                setLoading(true);
                setMessage(null);
                
                const result = await api.updateProfile(user.id, {
                    name: form.username,
                    phone: form.phone,
                    email: form.email,
                    upiId: form.upiId,
                    imageBase64: form.imageBase64
                });
                
                setLoading(false);
                
                if (result.success) {
                    setMessage({ type: 'success', text: 'Profile updated successfully!' });
                    if (result.data && result.data.user) {
                        onUpdate(result.data.user);
                        localStorage.setItem('fm_plat_user', JSON.stringify(result.data.user));
                    }
                } else {
                    setMessage({ type: 'error', text: result.error || 'Failed to update profile' });
                }
            };

            const updatePassword = async () => {
                if (securityForm.newPassword !== securityForm.confirmPassword) {
                    setMessage({ type: 'error', text: 'New passwords do not match' });
                    return;
                }

                if (!validatePassword(securityForm.newPassword)) {
                    setMessage({ type: 'error', text: 'Password must be at least 6 characters' });
                    return;
                }

                setLoading(true);
                setMessage(null);
                
                const result = await api.updatePassword(
                    user.id,
                    securityForm.currentPassword,
                    securityForm.newPassword
                );
                
                setLoading(false);
                
                if (result.success) {
                    setMessage({ type: 'success', text: 'Password updated successfully!' });
                    setSecurityForm({
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    });
                } else {
                    setMessage({ type: 'error', text: result.error || 'Failed to update password' });
                }
            };

            return (
                <div className="animate-fade space-y-8">
                    <div className="flex border-b border-slate-200 dark:border-slate-800">
                        <button 
                            onClick={() => setActiveTab('profile')}
                            className={`flex-1 py-3 text-sm font-bold ${activeTab === 'profile' ? `${THEMES[theme].text} border-b-2 ${THEMES[theme].border}` : 'text-slate-400'}`}
                        >
                            Profile
                        </button>
                        <button 
                            onClick={() => setActiveTab('security')}
                            className={`flex-1 py-3 text-sm font-bold ${activeTab === 'security' ? `${THEMES[theme].text} border-b-2 ${THEMES[theme].border}` : 'text-slate-400'}`}
                        >
                            Security
                        </button>
                    </div>

                    {message && (
                        <div className={`p-3 rounded-xl ${message.type === 'success' ? 'bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300' : 'bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300'}`}>
                            {message.text}
                        </div>
                    )}

                    {activeTab === 'profile' && (
                        <>
                            <div className="flex flex-col items-center">
                                <label className="relative cursor-pointer group">
                                    <Avatar imageId={user.imageId} name={user.name} size="lg" theme={theme} />
                                    <div className={`absolute bottom-0 right-0 rounded-full p-1 text-white ${THEMES[theme].class}`}>
                                        <i data-lucide="camera" className="w-4 h-4"></i>
                                    </div>
                                    <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                                </label>
                                <p className="mt-4 text-sm text-slate-400 font-bold">{user.email}</p>
                            </div>
                            
                            <div className="space-y-4">
                                <input 
                                    className="input-field" 
                                    value={form.username} 
                                    onChange={e => setForm({...form, username: e.target.value})} 
                                    placeholder="Full Name" 
                                />
                                <input 
                                    className="input-field" 
                                    value={form.phone} 
                                    onChange={e => setForm({...form, phone: e.target.value})} 
                                    placeholder="Phone Number" 
                                    type="tel"
                                />
                                <input 
                                    className="input-field" 
                                    value={form.email} 
                                    onChange={e => setForm({...form, email: e.target.value})} 
                                    placeholder="Email" 
                                    type="email"
                                />
                                <input 
                                    className="input-field" 
                                    value={form.upiId} 
                                    onChange={e => setForm({...form, upiId: e.target.value})} 
                                    placeholder="UPI ID (e.g., name@upi)" 
                                />
                            </div>
                            
                            <button 
                                onClick={saveProfile} 
                                disabled={loading}
                                className={`btn-primary shadow-lg ${THEMES[theme].class} ${loading ? 'opacity-50' : ''}`}
                            >
                                {loading ? 'Saving...' : 'Update Profile'}
                            </button>
                        </>
                    )}

                    {activeTab === 'security' && (
                        <div className="space-y-6">
                            <div className="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                                <h4 className="font-bold dark:text-white mb-2">Change Password</h4>
                                <div className="space-y-3">
                                    <input
                                        type="password"
                                        className="input-field"
                                        placeholder="Current Password"
                                        value={securityForm.currentPassword}
                                        onChange={e => setSecurityForm({...securityForm, currentPassword: e.target.value})}
                                    />
                                    <input
                                        type="password"
                                        className="input-field"
                                        placeholder="New Password"
                                        value={securityForm.newPassword}
                                        onChange={e => setSecurityForm({...securityForm, newPassword: e.target.value})}
                                    />
                                    <input
                                        type="password"
                                        className="input-field"
                                        placeholder="Confirm New Password"
                                        value={securityForm.confirmPassword}
                                        onChange={e => setSecurityForm({...securityForm, confirmPassword: e.target.value})}
                                    />
                                </div>

                                <button
                                    onClick={updatePassword}
                                    disabled={loading || !securityForm.currentPassword || !securityForm.newPassword}
                                    className={`w-full mt-4 py-2 rounded-lg text-white font-bold text-sm ${THEMES[theme].class} ${loading ? 'opacity-50' : ''}`}
                                >
                                    Update Password
                                </button>
                            </div>

                            <button
                                onClick={() => {
                                    if (window.confirm('Are you sure you want to log out?')) {
                                        onLogout();
                                    }
                                }}
                                className="w-full py-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold rounded-xl"
                            >
                                Logout
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Friend Modal
        function PersonModal({ user, onClose, theme }) {
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);

            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                
                setLoading(true);
                setMessage(null);
                
                const result = await api.searchUsers(searchQuery, user.id);
                setLoading(false);
                
                if (result.success) {
                    setSearchResults(result.data.results || []);
                    if (result.data.results.length === 0) {
                        setMessage({ type: 'info', text: 'No users found' });
                    }
                } else {
                    setMessage({ type: 'error', text: result.error || 'Search failed' });
                }
            };

            const sendFriendRequest = async (receiverEmail) => {
                setLoading(true);
                const result = await api.sendFriendRequest(user.id, receiverEmail);
                setLoading(false);
                
                if (result.success) {
                    setMessage({ type: 'success', text: 'Friend request sent!' });
                    setTimeout(() => {
                        onClose();
                    }, 1500);
                } else {
                    setMessage({ type: 'error', text: result.error || 'Failed to send friend request' });
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-slate-900/60 backdrop-blur-sm p-2 sm:items-center">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-md modal-inner shadow-2xl animate-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-xl dark:text-white">Add Friend</h3>
                            <button onClick={onClose}><i data-lucide="x" className="w-5 h-5 text-slate-400"></i></button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                    Search by Email
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        className="input-field"
                                        placeholder="friend@example.com"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                    />
                                    <button
                                        onClick={handleSearch}
                                        disabled={loading}
                                        className={`px-4 rounded-xl text-white font-bold ${THEMES[theme].class} ${loading ? 'opacity-50' : ''}`}
                                    >
                                        {loading ? '...' : 'Search'}
                                    </button>
                                </div>
                            </div>
                            
                            {message && (
                                <div className={`p-3 rounded-xl ${message.type === 'success' ? 'bg-emerald-50 text-emerald-700' : message.type === 'error' ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'}`}>
                                    {message.text}
                                </div>
                            )}
                            
                            {searchResults.length > 0 && (
                                <div className="space-y-3">
                                    <h4 className="font-bold dark:text-white">Search Results</h4>
                                    {searchResults.map((person) => (
                                        <div key={person.id} className="flex items-center justify-between p-3 rounded-xl border border-slate-200 dark:border-slate-800">
                                            <div className="flex items-center gap-3">
                                                <Avatar imageId={person.imageId} name={person.name} theme={theme} />
                                                <div>
                                                    <div className="font-bold dark:text-white">{person.name}</div>
                                                    <div className="text-sm text-slate-500">{person.email}</div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => sendFriendRequest(person.email)}
                                                disabled={loading}
                                                className={`px-3 py-1 rounded-lg text-sm font-bold ${THEMES[theme].class} text-white`}
                                            >
                                                Add
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Enhanced Transaction Modal
        function EnhancedTransactionModal({ user, people, editItem, onClose, theme, onSuccess, categories }) {
            const [tab, setTab] = useState(editItem ? (['lent','borrowed','repayment_in','repayment_out'].includes(editItem.friendType)?'friend':'simple') : 'simple');
            const [form, setForm] = useState(editItem ? { 
                ...editItem, 
                date: editItem.date ? editItem.date.split('T')[0] : new Date().toISOString().split('T')[0], 
                totalBill: editItem.totalBill || '',
                amount: editItem.amount || '',
                category: editItem.category || 'General'
            } : { 
                friendType: 'expense', 
                amount: '', 
                category: 'General', 
                description: '', 
                date: new Date().toISOString().split('T')[0], 
                relatedPerson: '', 
                paymentMode: 'Online', 
                totalBill: '' 
            });
            const [loading, setLoading] = useState(false);
            const [customCategories, setCustomCategories] = useState(categories || []);
            const [showCategoryInput, setShowCategoryInput] = useState(false);
            const [newCategory, setNewCategory] = useState('');

            const handleImage = (e) => { 
                const file = e.target.files[0]; 
                if(file) compressImage(file).then(b64 => setForm({...form, imageBase64: b64})); 
            };
           
            const addNewCategory = async () => {
                if (newCategory.trim()) {
                    const result = await api.addCategory(user.id, newCategory.trim());
                    if (result.success) {
                        setCustomCategories(prev => [...prev, newCategory.trim()]);
                        setForm(prev => ({ ...prev, category: newCategory.trim() }));
                        setNewCategory('');
                        setShowCategoryInput(false);
                    } else {
                        alert(result.error || 'Failed to add category');
                    }
                }
            };

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    let transactionData = {
                        userId: user.id,
                        amount: parseFloat(form.amount) || 0,
                        category: form.category,
                        description: form.description,
                        date: form.date,
                        paymentMode: form.paymentMode
                    };

                    if (form.imageBase64) {
                        transactionData.imageBase64 = form.imageBase64;
                    }

                    // Handle different transaction types
                    if (tab === 'simple') {
                        transactionData.transactionType = 'simple';
                        transactionData.friendType = form.friendType; // income or expense
                    } 
                    else if (tab === 'friend') {
                        transactionData.transactionType = 'friend';
                        transactionData.friendType = form.friendType; // lent, borrowed, repayment_in, repayment_out
                        transactionData.relatedPerson = form.relatedPerson;
                        
                        if (!transactionData.relatedPerson) {
                            alert('Please select a friend');
                            setLoading(false);
                            return;
                        }
                    }

                    const result = editItem && editItem.id 
                        ? await api.updateTransaction(editItem.id, transactionData)
                        : await api.createTransaction(transactionData);
                    
                    setLoading(false);
                    
                    if (result.success) {
                        onSuccess(result.transaction || editItem);
                        onClose();
                    } else {
                        alert(result.error || 'Failed to save transaction');
                    }
                } catch (error) {
                    setLoading(false);
                    alert('An error occurred');
                    console.error(error);
                }
            };
           
            const handleDelete = async () => { 
                if (editItem && editItem.id) {
                    if (window.confirm('Are you sure you want to delete this transaction?')) {
                        const result = await api.deleteTransaction(editItem.id, user.id);
                        if (result.success) {
                            onSuccess();
                            onClose();
                        } else {
                            alert(result.error || 'Failed to delete transaction');
                        }
                    }
                } else {
                    onClose();
                }
            };
            
            const commonCategories = [
                'Food', 'Transport', 'Housing', 'Utilities', 'Entertainment', 
                'Shopping', 'Healthcare', 'Education', 'Personal Care', 'Gifts',
                'Investment', 'Income', 'General'
            ];

            const allCategories = [...new Set([...commonCategories, ...customCategories])];
            
            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-slate-900/60 backdrop-blur-sm p-2 sm:items-center">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-md modal-inner shadow-2xl animate-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-xl dark:text-white">{editItem && editItem.id ? 'Edit Entry' : 'New Entry'}</h3>
                            <button onClick={onClose}><i data-lucide="x" className="w-5 h-5 text-slate-400"></i></button>
                        </div>
                        {!editItem && (
                            <div className="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-2xl mb-6">
                                {['simple', 'friend'].map(t => (
                                    <button key={t} onClick={()=>setTab(t)} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wider rounded-xl transition-all ${tab===t?'bg-white dark:bg-slate-700 shadow ' + THEMES[theme].text :'text-slate-400'}`}>
                                        {t}
                                    </button>
                                ))}
                            </div>
                        )}
                        <form onSubmit={submit} className="space-y-5">
                            {tab === 'simple' && (
                                <>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={()=>setForm({...form, friendType:'income'})} className={`flex-1 py-4 rounded-2xl border-2 font-bold transition-all ${form.friendType==='income'?'border-emerald-500 bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20':'border-transparent bg-slate-50 dark:bg-slate-800 text-slate-500'}`}>
                                            Money In
                                        </button>
                                        <button type="button" onClick={()=>setForm({...form, friendType:'expense'})} className={`flex-1 py-4 rounded-2xl border-2 font-bold transition-all ${form.friendType==='expense'?'border-red-500 bg-red-50 text-red-600 dark:bg-red-900/20':'border-transparent bg-slate-50 dark:bg-slate-800 text-slate-500'}`}>
                                            Money Out
                                        </button>
                                    </div>
                                    <div className={`bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border ${THEMES[theme].border} border-opacity-20`}>
                                        <p className={`text-xs font-bold uppercase ${THEMES[theme].text} mb-2`}>Amount</p>
                                        <input 
                                            type="number" 
                                            min="0" 
                                            step="0.01" 
                                            placeholder="₹0.00" 
                                            className={`w-full bg-transparent text-2xl font-bold outline-none ${THEMES[theme].text}`} 
                                            value={form.amount || ''} 
                                            onChange={e => setForm({...form, amount: e.target.value})} 
                                            required 
                                        />
                                    </div>
                                </>
                            )}
                            {tab === 'friend' && (
                                <>
                                    <select className="input-field" value={form.friendType} onChange={e=>setForm({...form, friendType:e.target.value})} required>
                                        <option value="lent">Money Rented (I gave)</option>
                                        <option value="borrowed">Money Taken (I took)</option>
                                        <option value="repayment_in">He Paid Back</option>
                                        <option value="repayment_out">I Paid Back</option>
                                    </select>
                                    <div className={`bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border ${THEMES[theme].border} border-opacity-20`}>
                                        <p className={`text-xs font-bold uppercase ${THEMES[theme].text} mb-2`}>Amount</p>
                                        <input 
                                            type="number" 
                                            min="0" 
                                            step="0.01" 
                                            placeholder="₹0.00" 
                                            className={`w-full bg-transparent text-2xl font-bold outline-none ${THEMES[theme].text}`} 
                                            value={form.amount || ''} 
                                            onChange={e => setForm({...form, amount: e.target.value})} 
                                            required 
                                        />
                                    </div>
                                    <div className="flex gap-4 overflow-x-auto pb-2 hide-scroll">
                                        {people.length === 0 ? (
                                            <p className="text-sm text-slate-400 text-center w-full py-4">No friends added yet. Add a friend first.</p>
                                        ) : (
                                            people.map(p => (
                                                <div key={p.id} onClick={()=>setForm({...form, relatedPerson: p.id})} className="flex flex-col items-center gap-2 cursor-pointer group">
                                                    <Avatar imageId={p.imageId} name={p.name} theme={theme} />
                                                    <span className={`text-[10px] font-bold ${form.relatedPerson === p.id ? THEMES[theme].text :'text-slate-500'}`}>{p.name}</span>
                                                    {!p.email && <span className="text-[8px] text-slate-400">Manual</span>}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    {form.friendType && ['lent', 'borrowed', 'repayment_in', 'repayment_out'].includes(form.friendType) && !form.relatedPerson && (
                                        <p className="text-xs text-amber-600 dark:text-amber-400 font-bold">⚠️ Please select a friend</p>
                                    )}
                                </>
                            )}
                            <div className="flex gap-2">
                                <button type="button" onClick={()=>setForm({...form, paymentMode:'Online'})} className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all ${form.paymentMode==='Online'?THEMES[theme].class + ' text-white shadow-lg':'bg-slate-100 dark:bg-slate-800 dark:text-slate-400'}`}>Online</button>
                                <button type="button" onClick={()=>setForm({...form, paymentMode:'Cash'})} className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all ${form.paymentMode==='Cash'?THEMES[theme].class + ' text-white shadow-lg':'bg-slate-100 dark:bg-slate-800 dark:text-slate-400'}`}>Cash</button>
                            </div>

                            <div className="relative">
                                <div className="flex items-center gap-2 mb-2">
                                    <input 
                                        className="input-field" 
                                        placeholder="Category (e.g., Food, Transport)" 
                                        value={form.category || ''} 
                                        onChange={e=>setForm({...form, category:e.target.value})} 
                                        list="category-suggestions"
                                        required 
                                    />
                                    <button 
                                        type="button"
                                        onClick={() => setShowCategoryInput(!showCategoryInput)}
                                        className={`p-2 rounded-lg ${THEMES[theme].class} text-white`}
                                    >
                                        <i data-lucide="plus" className="w-4 h-4"></i>
                                    </button>
                                </div>
                                <datalist id="category-suggestions">
                                    {allCategories.map(cat => (
                                        <option key={cat} value={cat} />
                                    ))}
                                </datalist>
                                
                                {showCategoryInput && (
                                    <div className="flex gap-2 mt-2">
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="New category name"
                                            value={newCategory}
                                            onChange={e => setNewCategory(e.target.value)}
                                        />
                                        <button
                                            type="button"
                                            onClick={addNewCategory}
                                            className="px-4 bg-emerald-500 text-white rounded-lg"
                                        >
                                            Add
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <textarea 
                                className="input-field" 
                                placeholder="Description (Optional)" 
                                value={form.description || ''} 
                                onChange={e=>setForm({...form, description:e.target.value})} 
                                rows="2" 
                            />
                            <label className="flex items-center gap-3 p-3 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center bg-slate-100 text-slate-400`}>
                                    <i data-lucide={form.imageBase64 ? 'check' : 'camera'}></i>
                                </div>
                                <span className="text-sm text-slate-500">{form.imageBase64 ? 'Receipt Attached' : 'Attach Receipt'}</span>
                                <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                            </label>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Date</label>
                                <input 
                                    className="input-field" 
                                    type="date" 
                                    value={form.date || ''} 
                                    onChange={e=>setForm({...form, date:e.target.value})} 
                                    required 
                                    max={new Date().toISOString().split('T')[0]}
                                />
                            </div>
                            <button 
                                disabled={loading} 
                                className={`btn-primary shadow-xl text-lg ${THEMES[theme].class} ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                {loading ? 'Saving...' : (editItem && editItem.id ? 'Update' : 'Save')}
                            </button>
                            {editItem && editItem.id && (
                                <button type="button" onClick={handleDelete} className="w-full py-3 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-xl">
                                    Delete Entry
                                </button>
                            )}
                        </form>
                    </div>
                </div>
            );
        }

        // Enhanced Dashboard
        function EnhancedDashboard({ user, onLogout }) {
            const [data, setData] = useState({ transactions: [], people: [], notifications: [], categories: [] });
            const [dashboardData, setDashboardData] = useState(null);
            const [view, setView] = useState('home');
            const [modal, setModal] = useState(null);
            const [editItem, setEditItem] = useState(null);
            const [selectedFriend, setSelectedFriend] = useState(null);
            const [dialog, setDialog] = useState({ isOpen: false });
            const [darkMode, setDarkMode] = useState(true);
            const [currentUser, setCurrentUser] = useState(user);
            const [loading, setLoading] = useState(false);
            const [refreshing, setRefreshing] = useState(false);
            const [filterDays, setFilterDays] = useState('TODAY');
            const [searchTerm, setSearchTerm] = useState('');
            const [activeGraph, setActiveGraph] = useState('trend');
            const [dateFrom, setDateFrom] = useState(new Date().toISOString().split('T')[0]);
            const [dateTo, setDateTo] = useState(new Date().toISOString().split('T')[0]);
            const [filterType, setFilterType] = useState('ALL');
            const [theme, setTheme] = useState(localStorage.getItem('fm_theme') || 'indigo');
            const [accentColor, setAccentColor] = useState(localStorage.getItem('fm_accent') || THEMES[localStorage.getItem('fm_theme') || 'indigo'].bg);
            const [budget, setBudget] = useState(localStorage.getItem('fm_budget') || '0');
            const [budgetWarning, setBudgetWarning] = useState(false);
            const [showVerification, setShowVerification] = useState(!user.phoneVerified);

            // Fetch data on component mount
            useEffect(() => {
                fetchData();
            }, [currentUser.id]);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                document.documentElement.style.setProperty('--theme-color', accentColor || THEMES[theme].bg);
                localStorage.setItem('fm_theme', theme);
                localStorage.setItem('fm_accent', accentColor);
            }, [darkMode, theme, accentColor]);

            useEffect(() => { 
                setTimeout(() => lucide.createIcons(), 200); 
            }, [view, modal, data, dialog, filterDays, theme, activeGraph, selectedFriend, refreshing]);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const dateRange = getDateRange(filterDays);
                    const filters = {};
                    if (dateRange.start && dateRange.end) {
                        filters.startDate = dateRange.start;
                        filters.endDate = dateRange.end;
                    }
                    
                    const [dashboardResult, transactionsResult, friendsResult, notificationsResult, categoriesResult] = await Promise.all([
                        api.getDashboardData(currentUser.id),
                        api.getTransactions(currentUser.id, filters),
                        api.getFriends(currentUser.id),
                        api.getNotifications(currentUser.id),
                        api.getCategories(currentUser.id)
                    ]);

                    if (dashboardResult.success) setDashboardData(dashboardResult.data);
                    if (transactionsResult.success) setData(prev => ({ ...prev, transactions: transactionsResult.data.transactions || [] }));
                    if (friendsResult.success) setData(prev => ({ ...prev, people: friendsResult.data.friends || [] }));
                    if (notificationsResult.success) setData(prev => ({ ...prev, notifications: notificationsResult.data.notifications || [] }));
                    if (categoriesResult.success) setData(prev => ({ ...prev, categories: categoriesResult.data.categories || [] }));

                    // Check budget
                    if (dashboardResult.success && parseFloat(budget) > 0) {
                        const totalSpent = dashboardResult.data.totals?.expenses || 0;
                        if (totalSpent > parseFloat(budget)) {
                            setBudgetWarning(true);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                } finally {
                    setLoading(false);
                    setRefreshing(false);
                }
            };
            
            const handleRefresh = () => {
                setRefreshing(true);
                fetchData();
            };
            
            const confirmAction = (title, msg, onConfirm, type = 'neutral') => setDialog({ 
                isOpen: true, 
                title, 
                msg, 
                onConfirm: () => { 
                    onConfirm(); 
                    setDialog({ isOpen: false }); 
                }, 
                onCancel: () => setDialog({ isOpen: false }), 
                type 
            });

            const clearFilters = () => {
                setFilterDays('TODAY');
                setFilterType('ALL');
                setSearchTerm('');
                setDateFrom(new Date().toISOString().split('T')[0]);
                setDateTo(new Date().toISOString().split('T')[0]);
                fetchData();
            };
            
            const exportCSV = () => {
                const headers = ['Date', 'Type', 'Amount', 'Category', 'Description', 'Payment Mode', 'Status'];
                const csvContent = [
                    headers.join(','),
                    ...data.transactions.map(t => [
                        t.date,
                        t.friendType,
                        t.amount,
                        t.category,
                        `"${t.description || ''}"`,
                        t.paymentMode,
                        t.status
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };
            
            const stats = useMemo(() => {
                if (!dashboardData) {
                    return {
                        cashBal: 0,
                        onlineBal: 0,
                        total: 0,
                        pendingTotal: 0,
                        rented: 0,
                        taken: 0,
                        totalExpenses: 0,
                        insight: "✅ Financial health looks stable.",
                        pieData: [],
                        barData: [],
                        graphArea: [],
                        peopleStats: []
                    };
                }

                const { balances, pendingBalances, recentTransactions, insights } = dashboardData;
                
                // Calculate category data for pie chart
                const categoryMap = {};
                data.transactions.forEach(t => {
                    if (t.friendType === 'expense') {
                        categoryMap[t.category] = (categoryMap[t.category] || 0) + t.amount;
                    }
                });

                const pieData = Object.entries(categoryMap).map(([name, value], index) => ({
                    name,
                    value,
                    color: COLORS[index % COLORS.length]
                }));

                // Calculate analysis data for bar chart
                const analysisData = [
                    { name: 'Incoming', value: data.transactions.filter(t => t.friendType === 'income').reduce((sum, t) => sum + t.amount, 0) },
                    { name: 'Outgoing', value: data.transactions.filter(t => t.friendType === 'expense').reduce((sum, t) => sum + t.amount, 0) },
                    { name: 'Given', value: data.transactions.filter(t => t.friendType === 'lent').reduce((sum, t) => sum + t.amount, 0) },
                    { name: 'Taken', value: data.transactions.filter(t => t.friendType === 'borrowed').reduce((sum, t) => sum + t.amount, 0) }
                ];

                // Calculate cash flow data
                const last7Days = Array.from({ length: 7 }, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    return date.toISOString().split('T')[0];
                }).reverse();

                const graphArea = last7Days.map(date => {
                    const dayTransactions = data.transactions.filter(t => t.date && t.date.startsWith(date));
                    const netFlow = dayTransactions.reduce((sum, t) => {
                        if (t.friendType === 'income') return sum + t.amount;
                        if (t.friendType === 'expense') return sum - t.amount;
                        return sum;
                    }, 0);
                    return { date, val: netFlow };
                });

                // Calculate friend stats
                const peopleStats = data.people.map(person => {
                    const friendTransactions = data.transactions.filter(t => 
                        t.relatedPerson === person.id
                    );
                    
                    const owedToMe = friendTransactions
                        .filter(t => t.friendType === 'lent' && t.status === 'Pending')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const iOwe = friendTransactions
                        .filter(t => t.friendType === 'borrowed' && t.status === 'Pending')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const netBalance = owedToMe - iOwe;
                    
                    return {
                        ...person,
                        owedToMe,
                        iOwe,
                        netBalance
                    };
                });

                return {
                    cashBal: balances?.cash || 0,
                    onlineBal: balances?.online || 0,
                    total: balances?.total || 0,
                    pendingTotal: pendingBalances?.total || 0,
                    rented: analysisData[2].value || 0,
                    taken: analysisData[3].value || 0,
                    totalExpenses: analysisData[1].value || 0,
                    insight: insights || "✅ Financial health looks stable.",
                    pieData,
                    barData: analysisData,
                    graphArea,
                    peopleStats
                };
            }, [dashboardData, data.people, data.transactions, budget, budgetWarning, currentUser.id]);

            const requests = data.notifications.filter(n => 
                n.type === 'friend_request' || n.status === 'unread'
            );
            
            const filterTransactions = (list) => {
                let filtered = list;
                
                // Apply date filter
                if (filterDays === 'RANGE' && dateFrom && dateTo) {
                    filtered = filtered.filter(t => {
                        const tDate = new Date(t.date);
                        const fromDate = new Date(dateFrom);
                        const toDate = new Date(dateTo);
                        toDate.setDate(toDate.getDate() + 1); // Include end date
                        return tDate >= fromDate && tDate <= toDate;
                    });
                } else if (filterDays !== 'ALL') {
                    const range = getDateRange(filterDays);
                    if (range.start && range.end) {
                        filtered = filtered.filter(t => {
                            const tDate = new Date(t.date);
                            return tDate >= new Date(range.start) && tDate <= new Date(range.end);
                        });
                    }
                }
                
                // Apply type filter
                if (filterType !== 'ALL') {
                    filtered = filtered.filter(t => {
                        if (filterType === 'INCOMING') return t.friendType === 'income';
                        if (filterType === 'OUTGOING') return t.friendType === 'expense';
                        if (filterType === 'REPAYMENT') return ['lent', 'borrowed', 'repayment_in', 'repayment_out'].includes(t.friendType);
                        return true;
                    });
                }
                
                // Apply search filter
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(t => 
                        t.description?.toLowerCase().includes(term) ||
                        t.category?.toLowerCase().includes(term) ||
                        t.amount.toString().includes(term)
                    );
                }
                
                return filtered;
            };
            
            const filteredHistory = filterTransactions(data.transactions);
            
            const historySummary = useMemo(() => {
                return filteredHistory.reduce((acc, t) => {
                    if (t.friendType === 'income') {
                        acc.in += t.amount;
                    } else if (t.friendType === 'expense') {
                        acc.out += t.amount;
                    }
                    return acc;
                }, { in: 0, out: 0 });
            }, [filteredHistory]);
            
            const renderTransactionItem = (transaction) => {
                const isIncome = transaction.friendType === 'income';
                const isPending = transaction.status === 'Pending';
                const friend = data.people.find(p => p.id === transaction.relatedPerson);
                
                return (
                    <div key={transaction.id} className={`p-4 rounded-xl border ${isPending ? 'border-amber-200 dark:border-amber-800' : 'border-slate-200 dark:border-slate-800'} bg-white dark:bg-slate-900 mb-3`}>
                        <div className="flex justify-between items-start">
                            <div className="flex items-center gap-3">
                                {isPending ? (
                                    <div className="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/20 flex items-center justify-center">
                                        <i data-lucide="clock" className="w-5 h-5 text-amber-600"></i>
                                    </div>
                                ) : isIncome ? (
                                    <div className="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/20 flex items-center justify-center">
                                        <i data-lucide="arrow-down-right" className="w-5 h-5 text-emerald-600"></i>
                                    </div>
                                ) : (
                                    <div className="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/20 flex items-center justify-center">
                                        <i data-lucide="arrow-up-right" className="w-5 h-5 text-red-600"></i>
                                    </div>
                                )}
                                <div>
                                    <div className="font-bold dark:text-white">{transaction.category}</div>
                                    <div className="text-sm text-slate-500">{transaction.description || 'No description'}</div>
                                    {friend && (
                                        <div className="text-xs text-slate-400 mt-1">
                                            {transaction.friendType === 'lent' ? `To: ${friend.name}` : 
                                             transaction.friendType === 'borrowed' ? `From: ${friend.name}` : ''}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className={`text-right ${isPending ? 'text-amber-600' : isIncome ? 'text-emerald-600' : 'text-red-600'}`}>
                                <div className="font-bold">{isIncome ? '+' : '-'}{formatCurrency(transaction.amount)}</div>
                                <div className="text-xs text-slate-400">{new Date(transaction.date).toLocaleDateString()}</div>
                                <div className="text-xs mt-1">
                                    <TransactionStateBadge status={transaction.status} theme={theme} small />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="h-full w-full flex flex-col bg-slate-50 dark:bg-slate-950">
                    {/* Verification Modal */}
                    {showVerification && (
                        <VerificationModal 
                            user={currentUser} 
                            onComplete={() => setShowVerification(false)} 
                            onSkip={() => setShowVerification(false)} 
                            theme={theme} 
                        />
                    )}
                    
                    {/* Budget Warning Modal */}
                    {budgetWarning && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 animate-up shadow-2xl">
                                <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="alert-triangle" className="w-8 h-8"></i>
                                </div>
                                <h3 className="font-bold text-xl dark:text-white mb-2 text-center">Budget Exceeded!</h3>
                                <p className="text-slate-500 text-center mb-6">
                                    You have exceeded your monthly budget of ₹{budget}.<br />
                                    Total spent: ₹{stats.totalExpenses || 0}
                                </p>
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => {
                                            setBudgetWarning(false);
                                            setModal('budgetUpdate');
                                        }}
                                        className={`w-full py-3 rounded-xl text-white font-bold ${THEMES[theme].class}`}
                                    >
                                        Update Budget
                                    </button>
                                    <button 
                                        onClick={() => setBudgetWarning(false)}
                                        className="w-full py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold"
                                    >
                                        Continue Anyway
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <header className="px-6 py-4 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center z-20">
                        <div className="flex items-center gap-3">
                            <Avatar imageId={currentUser.imageId} name={currentUser.name} theme={theme} />
                            <div>
                                <h1 className="font-bold dark:text-white leading-tight">Hi, {currentUser.name.split(' ')[0]}</h1>
                                <p className="text-xs text-slate-500">
                                    {stats.total ? formatCurrency(stats.total) : '₹0.00'} • {stats.pendingTotal ? `${formatCurrency(stats.pendingTotal)} pending` : 'No pending'}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleRefresh} className={`icon-btn flex items-center justify-center ${refreshing ? 'animate-spin-once' : ''}`} style={{color: THEMES[theme].bg}}>
                                <i data-lucide="refresh-cw" className="w-5 h-5"></i>
                            </button>
                            <button onClick={()=>setDarkMode(!darkMode)} className="icon-btn">
                                <i data-lucide={darkMode?"sun":"moon"} className="w-5 h-5"></i>
                            </button>
                            <button onClick={onLogout} className="icon-btn text-red-500 bg-red-50 dark:bg-red-900/20">
                                <i data-lucide="log-out" className="w-5 h-5"></i>
                            </button>
                        </div>
                    </header>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-6">
                       
                        {view === 'home' && (
                            <div className="space-y-6 animate-fade">
                                {/* Main Balance Card */}
                                <div className="glass p-6 rounded-[2rem] text-white shadow-xl shadow-indigo-500/30" style={{background: `linear-gradient(135deg, ${THEMES[theme].bg} 0%, #1e1b4b 100%)`}}>
                                    <p className="text-white/70 text-xs font-bold uppercase tracking-wider mb-1">Total Actual Balance</p>
                                    <h2 className="text-4xl font-bold">{formatCurrency(stats.total)}</h2>
                                    {stats.pendingTotal > 0 && (
                                        <p className="text-white/70 text-sm mt-2">
                                            + {formatCurrency(stats.pendingTotal)} pending
                                        </p>
                                    )}
                                    <div className="mt-6 flex gap-3">
                                        <div className="bg-white/10 px-4 py-2 rounded-xl border border-white/10 backdrop-blur-md flex-1">
                                            <p className="text-[10px] text-white/70 font-bold uppercase">Online</p>
                                            <p className="font-bold text-lg">{formatCurrency(stats.onlineBal)}</p>
                                        </div>
                                        <div className="bg-white/10 px-4 py-2 rounded-xl border border-white/10 backdrop-blur-md flex-1">
                                            <p className="text-[10px] text-white/70 font-bold uppercase">Cash</p>
                                            <p className="font-bold text-lg">{formatCurrency(stats.cashBal)}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Insight */}
                                <div className="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 text-xs font-bold rounded-xl flex items-center gap-3 border border-blue-100 dark:border-blue-900/50">
                                    <i data-lucide="sparkles" className="w-5 h-5 shrink-0"></i>
                                    {stats.insight}
                                </div>
                                
                                {/* Budget */}
                                {parseInt(budget) > 0 && (
                                    <div className="bg-white dark:bg-slate-900 p-4 rounded-[1.5rem] shadow-sm border border-slate-200 dark:border-slate-800">
                                        <div className="flex justify-between text-xs font-bold mb-2">
                                            <span className="text-slate-500">Monthly Budget</span>
                                            <span>{formatCurrency(stats.totalExpenses || 0)} / {formatCurrency(budget)}</span>
                                        </div>
                                        <div className="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                            <div 
                                                className={`h-full rounded-full transition-all duration-500 ${THEMES[theme].class}`} 
                                                style={{width: `${Math.min(100, ((stats.totalExpenses || 0) / parseFloat(budget)) * 100)}%`}}
                                            >
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Assets and Liabilities */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div className="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] shadow-sm">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Assets (Rented)</p>
                                        <p className="text-xl font-bold" style={{color: accentColor}}>{formatCurrency(stats.rented)}</p>
                                    </div>
                                    <div className="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] shadow-sm">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Liabilities (Taken)</p>
                                        <p className="text-xl font-bold" style={{color: accentColor}}>{formatCurrency(stats.taken)}</p>
                                    </div>
                                </div>
                                
                                {/* Graph Toggle */}
                                <div className="flex justify-center bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                    {['trend', 'bar', 'pie'].map(g => (
                                        <button key={g} onClick={()=>setActiveGraph(g)} 
                                                className={`flex-1 py-2 text-xs font-bold rounded-lg capitalize transition-all ${activeGraph===g ? 'bg-white dark:bg-slate-700 shadow text-slate-900 dark:text-white' : 'text-slate-400'}`}>
                                            {g === 'trend' ? 'Cash Flow' : g === 'bar' ? 'Analysis' : 'Category'}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Charts */}
                                <div className="h-64 bg-white dark:bg-slate-900 rounded-[2rem] p-4 shadow-sm border border-slate-200 dark:border-slate-800">
                                    <ResponsiveContainer width="100%" height="100%">
                                        {activeGraph === 'trend' ? (
                                            <AreaChart data={stats.graphArea}>
                                                <defs>
                                                    <linearGradient id="c" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor={THEMES[theme].bg} stopOpacity={0.3}/>
                                                        <stop offset="95%" stopColor={THEMES[theme].bg} stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <XAxis dataKey="date" tick={{fontSize: 10}} stroke="#94a3b8" />
                                                <YAxis tick={{fontSize: 10}} stroke="#94a3b8" />
                                                <Tooltip 
                                                    formatter={(value) => [formatCurrency(value), 'Net Flow']}
                                                    labelFormatter={(label) => `Date: ${label}`}
                                                />
                                                <Area type="monotone" dataKey="val" stroke={THEMES[theme].bg} fill="url(#c)" strokeWidth={3} />
                                            </AreaChart>
                                        ) : activeGraph === 'bar' ? (
                                            <BarChart data={stats.barData}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                                <XAxis dataKey="name" tick={{fontSize: 10}} stroke="#94a3b8" />
                                                <YAxis tick={{fontSize: 10}} stroke="#94a3b8" />
                                                <Tooltip 
                                                    formatter={(value) => [formatCurrency(value), 'Amount']}
                                                />
                                                <Bar dataKey="value" fill={THEMES[theme].bg} radius={[4, 4, 0, 0]} />
                                            </BarChart>
                                        ) : (
                                            <PieChart>
                                                <Pie 
                                                    data={stats.pieData} 
                                                    innerRadius={60} 
                                                    outerRadius={80} 
                                                    paddingAngle={5} 
                                                    dataKey="value" 
                                                    nameKey="name"
                                                    label={(entry) => `${entry.name}: ${formatCurrency(entry.value)}`}
                                                >
                                                    {stats.pieData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={entry.color || COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip formatter={(value) => formatCurrency(value)} />
                                                <Legend />
                                            </PieChart>
                                        )}
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                        
                        {view === 'requests' && (
                            <div className="space-y-4 animate-fade">
                                <h2 className="text-xl font-bold dark:text-white px-2">Notifications</h2>
                                {requests.length === 0 && <p className="text-center text-slate-400 mt-10">No notifications.</p>}
                                {requests.map(notification => (
                                    <div key={notification.id} className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800">
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                                    notification.type === 'friend_request' ? 'bg-blue-100 text-blue-600' : 
                                                    notification.status === 'unread' ? 'bg-amber-100 text-amber-600' : 
                                                    'bg-slate-100 text-slate-600'
                                                }`}>
                                                    <i data-lucide={
                                                        notification.type === 'friend_request' ? 'user-plus' : 
                                                        notification.status === 'unread' ? 'bell' : 'check-circle'
                                                    } className="w-5 h-5"></i>
                                                </div>
                                                <div>
                                                    <div className="font-bold dark:text-white">{notification.title}</div>
                                                    <div className="text-sm text-slate-500">{notification.message}</div>
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        {new Date(notification.createdAt).toLocaleDateString()}
                                                    </div>
                                                </div>
                                            </div>
                                            {notification.status === 'unread' && (
                                                <button 
                                                    onClick={async () => {
                                                        const result = await api.markNotificationRead(notification.id);
                                                        if (result.success) {
                                                            fetchData();
                                                        }
                                                    }}
                                                    className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-sm"
                                                >
                                                    Mark Read
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {(view === 'history' || (view === 'people' && selectedFriend)) && (
                            <div className="space-y-4 animate-fade">
                                <div className="flex justify-between items-center px-2">
                                    <h2 className="text-xl font-bold dark:text-white">{selectedFriend ? `History w/ ${selectedFriend.name}` : 'Transactions'}</h2>
                                    <div className="text-xs text-slate-400">
                                        Showing {filteredHistory.length} transactions
                                    </div>
                                </div>
                               
                                {!selectedFriend && (
                                    <>
                                        <div className="px-2 space-y-3">
                                            {/* Time Filters */}
                                            <div className="scroll-x flex gap-2 pb-1">
                                                {[
                                                    { id: 'TODAY', label: 'Today' },
                                                    { id: 'YESTERDAY', label: 'Yesterday' },
                                                    { id: '7', label: 'Last 7 Days' },
                                                    { id: '30', label: 'Last 30 Days' },
                                                    { id: 'RANGE', label: 'Range' },
                                                    { id: 'ALL', label: 'All Time' }
                                                ].map(f => (
                                                    <button key={f.id} onClick={()=>{
                                                        setFilterDays(f.id);
                                                        if(f.id === 'TODAY') { 
                                                            const now = new Date();
                                                            const s = now.toISOString().split('T')[0]; 
                                                            setDateFrom(s); 
                                                            setDateTo(s); 
                                                        }
                                                        else if(f.id === 'YESTERDAY') { 
                                                            const y = new Date(Date.now() - 86400000); 
                                                            const s = y.toISOString().split('T')[0]; 
                                                            setDateFrom(s); 
                                                            setDateTo(s); 
                                                        }
                                                        else if(f.id === 'RANGE') { 
                                                            const now = new Date();
                                                            const s = now.toISOString().split('T')[0]; 
                                                            setDateFrom(s); 
                                                            setDateTo(s); 
                                                        }
                                                        else { 
                                                            setDateFrom(null); 
                                                            setDateTo(null); 
                                                        }
                                                        fetchData();
                                                    }} 
                                                    className={`px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-tight transition-all ${filterDays===f.id ? THEMES[theme].class + ' text-white shadow-md' : 'bg-white dark:bg-slate-900 text-slate-500 border border-slate-200 dark:border-slate-800'}`}>
                                                        {f.label}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {/* Date Range Inputs */}
                                            {filterDays === 'RANGE' && (
                                                <div className="flex items-center gap-2 animate-fade flex-wrap">
                                                    <span className="text-xs font-bold text-slate-400 uppercase">From</span>
                                                    <input type="date" className="p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-sm outline-none" value={dateFrom || ''} onChange={e=>setDateFrom(e.target.value)} />
                                                    <span className="text-xs font-bold text-slate-400 uppercase">To</span>
                                                    <input type="date" className="p-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-sm outline-none" value={dateTo || ''} onChange={e=>setDateTo(e.target.value)} />
                                                    <button onClick={()=>{
                                                        setFilterDays('RANGE'); 
                                                        fetchData();
                                                    }} className="py-1 px-2 rounded-md text-xs bg-slate-100 dark:bg-slate-800">
                                                        Apply
                                                    </button>
                                                </div>
                                            )}

                                            {/* Type Filters */}
                                            <div className="flex items-center gap-2 mt-3 flex-wrap">
                                                <span className="text-xs font-bold text-slate-400 uppercase">Type</span>
                                                {[
                                                    { id: 'ALL', label: 'All' },
                                                    { id: 'INCOMING', label: 'Incoming' },
                                                    { id: 'OUTGOING', label: 'Outgoing' },
                                                    { id: 'REPAYMENT', label: 'Repayment' }
                                                ].map(ft => (
                                                    <button key={ft.id} onClick={() => {
                                                        setFilterType(ft.id);
                                                        fetchData();
                                                    }} 
                                                            className={`px-3 py-2 rounded-full text-[10px] font-bold uppercase tracking-tight transition-all ${filterType===ft.id ? THEMES[theme].class + ' text-white shadow-md' : 'bg-white dark:bg-slate-900 text-slate-500 border border-slate-200 dark:border-slate-800'}`}>
                                                        {ft.label}
                                                    </button>
                                                ))}
                                                {(filterDays !== 'ALL' || filterType !== 'ALL') && (
                                                    <button onClick={clearFilters} className="px-3 py-2 rounded-full text-[10px] font-bold uppercase tracking-tight bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                                                        Clear
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Summary Cards */}
                                        <div className="grid grid-cols-2 gap-3 px-2">
                                            <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Incoming</p>
                                                </div>
                                                <p className="text-lg font-bold text-emerald-600">{formatCurrency(historySummary.in)}</p>
                                            </div>
                                            <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <div className="w-2 h-2 rounded-full bg-red-500"></div>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Outgoing</p>
                                                </div>
                                                <p className="text-lg font-bold text-red-600">{formatCurrency(historySummary.out)}</p>
                                            </div>
                                        </div>
                                        
                                        {/* Search */}
                                        <div className="px-4 mb-2">
                                            <div className="flex items-center bg-white dark:bg-slate-900 rounded-xl px-3 py-3 border border-slate-200 dark:border-slate-800">
                                                <i data-lucide="search" className="w-4 h-4 text-slate-400 mr-2"></i>
                                                <input className="bg-transparent outline-none w-full text-sm dark:text-white" 
                                                       placeholder="Search transactions..." 
                                                       value={searchTerm} 
                                                       onChange={e => setSearchTerm(e.target.value)} />
                                            </div>
                                        </div>
                                    </>
                                )}
                               
                                {/* Transactions List */}
                                {filteredHistory.length === 0 ? (
                                    <p className="text-center text-slate-400 mt-10">No transactions found.</p>
                                ) : (
                                    <div className="px-2">
                                        {filteredHistory.map(renderTransactionItem)}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {view === 'people' && !selectedFriend && (
                            <div className="space-y-4 animate-fade">
                                <div className="px-4 mb-2">
                                    <div className="flex items-center bg-white dark:bg-slate-900 rounded-xl px-3 py-3 border border-slate-200 dark:border-slate-800">
                                        <i data-lucide="search" className="w-4 h-4 text-slate-400 mr-2"></i>
                                        <input className="bg-transparent outline-none w-full text-sm dark:text-white" 
                                               placeholder="Search friends..." 
                                               value={searchTerm} 
                                               onChange={e => setSearchTerm(e.target.value)} />
                                    </div>
                                </div>
                                <div className="flex justify-between items-center px-2">
                                    <h2 className="text-xl font-bold dark:text-white">Friends</h2>
                                    <button onClick={()=>{setModal('person');}} 
                                            className={`text-white px-3 py-2 rounded-md text-xs font-bold shadow-lg ${THEMES[theme].class}`}>
                                        + Add Friend
                                    </button>
                                </div>
                                
                                {/* Friends List */}
                                <div className="px-2 space-y-3">
                                    {stats.peopleStats.map(person => (
                                        <div key={person.id} 
                                             className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800"
                                             onClick={() => setSelectedFriend(person)}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <Avatar imageId={person.imageId} name={person.name} theme={theme} />
                                                    <div>
                                                        <div className="font-bold dark:text-white">{person.name}</div>
                                                        {!person.email && <span className="text-xs text-slate-500">Manual</span>}
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    {person.netBalance > 0 ? (
                                                        <div className="text-emerald-600 font-bold">
                                                            Will pay {formatCurrency(person.netBalance)}
                                                        </div>
                                                    ) : person.netBalance < 0 ? (
                                                        <div className="text-red-600 font-bold">
                                                            You owe {formatCurrency(Math.abs(person.netBalance))}
                                                        </div>
                                                    ) : (
                                                        <div className="text-slate-400 text-sm">Settled</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {view === 'profile' && (
                            <div className="space-y-6 animate-fade">
                                <EnhancedProfileView 
                                    user={currentUser} 
                                    onUpdate={u => setCurrentUser(u)} 
                                    theme={theme} 
                                    setTheme={setTheme} 
                                    setAccentColor={setAccentColor}
                                    onLogout={onLogout}
                                />
                                <div className="px-4">
                                    <p className="text-xs font-bold text-slate-400 uppercase mb-3">Settings</p>
                                    <div className="bg-white dark:bg-slate-900 rounded-[1.5rem] p-4 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm font-bold dark:text-white">Monthly Budget</span>
                                            <input type="number" 
                                                   className="w-24 text-right bg-slate-100 dark:bg-slate-800 rounded-lg px-2 py-1 text-sm outline-none" 
                                                   placeholder="0" 
                                                   value={budget} 
                                                   onChange={e=>{
                                                       const value = e.target.value;
                                                       setBudget(value); 
                                                       localStorage.setItem('fm_budget', value);
                                                   }} />
                                        </div>
                                        <div className="flex justify-between items-center theme-row">
                                            <span className="text-sm font-bold dark:text-white">Theme</span>
                                            <div className="flex gap-2 items-center min-w-0">
                                                <div className="theme-swatches flex-1 flex flex-wrap gap-2 min-w-0">
                                                    {Object.keys(THEMES).map(c => (
                                                        <button key={c} 
                                                                onClick={()=>{
                                                                    setTheme(c); 
                                                                    localStorage.setItem('fm_theme', c); 
                                                                    setAccentColor(THEMES[c].bg);
                                                                }} 
                                                                className={`swatch w-6 h-6 rounded-full cursor-pointer border-2 ${theme===c?'border-slate-900 dark:border-white':'border-transparent'}`} 
                                                                style={{backgroundColor:THEMES[c].bg}} 
                                                                aria-label={`Theme ${c}`} 
                                                                title={c}></button>
                                                    ))}
                                                </div>
                                                <input type="color" 
                                                       value={accentColor} 
                                                       onChange={e=>{
                                                           setAccentColor(e.target.value); 
                                                           localStorage.setItem('fm_accent', e.target.value);
                                                       }} 
                                                       className="ml-2 w-8 h-8 p-0 border-0" />
                                            </div>
                                        </div>
                                        <button onClick={exportCSV} 
                                                className="w-full py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl text-sm flex justify-center gap-2">
                                            <i data-lucide="download" className="w-4 h-4"></i> Export Data (CSV)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Floating Action Button */}
                    <button onClick={()=>{setEditItem(null); setModal('add');}} 
                            className={`absolute bottom-16 sm:bottom-24 right-4 sm:right-6 w-12 sm:w-16 h-12 sm:h-16 text-white rounded-full shadow-xl flex items-center justify-center z-30 transition-transform active:scale-90 ${THEMES[theme].class}`}>
                        <i data-lucide="plus" className="w-6 sm:w-8 h-6 sm:h-8"></i>
                    </button>
                    
                    {/* Bottom Navigation */}
                    <div className="absolute bottom-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 px-4 py-3 sm:px-6 flex justify-between items-center z-40 pb-safe">
                        {['home','history','people','requests','profile'].map(v => (
                            <button key={v} 
                                    onClick={()=>{
                                        setView(v); 
                                        setSelectedFriend(null); 
                                    }} 
                                    className={`flex flex-col items-center gap-1 transition-all ${view===v?THEMES[theme].text + ' scale-110':'text-slate-400 dark:text-slate-600'}`}>
                                <div className="relative">
                                    <i data-lucide={v==='home'?'home':v==='history'?'list':v==='people'?'users':v==='requests'?'bell':'user'} 
                                       className={`w-6 h-6 ${view===v && 'fill-current opacity-20'}`}></i>
                                    {v==='requests' && requests.length > 0 && (
                                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
                                    )}
                                </div>
                            </button>
                        ))}
                    </div>
                    
                    {/* Friend Detail Header */}
                    {selectedFriend && (
                        <div className="absolute top-0 left-0 w-full h-20 bg-white dark:bg-slate-900 flex items-center px-4 z-50 border-b border-slate-200 dark:border-slate-800 animate-fade">
                            <button onClick={()=>setSelectedFriend(null)} className="p-2 -ml-2 text-slate-500">
                                <i data-lucide="arrow-left" className="w-6 h-6"></i>
                            </button>
                            <div className="ml-3 flex items-center gap-3">
                                <Avatar imageId={selectedFriend.imageId} name={selectedFriend.name} theme={theme} />
                                <div>
                                    <h2 className="font-bold text-lg dark:text-white">{selectedFriend.name}</h2>
                                    <p className="text-xs text-slate-500">
                                        {selectedFriend.netBalance > 0 ? 
                                            `Will pay ${formatCurrency(selectedFriend.netBalance)}` : 
                                            selectedFriend.netBalance < 0 ? 
                                            `You owe ${formatCurrency(Math.abs(selectedFriend.netBalance))}` : 
                                            'Settled'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Confirmation Dialog */}
                    <ConfirmDialog isOpen={dialog.isOpen} 
                                   title={dialog.title} 
                                   msg={dialog.msg} 
                                   onConfirm={dialog.onConfirm} 
                                   onCancel={dialog.onCancel} 
                                   type={dialog.type} 
                                   theme={theme} 
                                   single={dialog.single} 
                                   confirmLabel={dialog.confirmLabel} />
                   
                    {/* Transaction Modal */}
                    {modal === 'add' && (
                        <EnhancedTransactionModal 
                            user={currentUser} 
                            people={data.people} 
                            editItem={editItem} 
                            onClose={()=>{
                                setModal(null); 
                                setEditItem(null);
                            }} 
                            theme={theme} 
                            onSuccess={fetchData}
                            categories={data.categories}
                        />
                    )}
                    
                    {/* Friend Modal */}
                    {modal === 'person' && (
                        <PersonModal 
                            user={currentUser} 
                            onClose={()=>{
                                setModal(null); 
                            }} 
                            theme={theme} 
                        />
                    )}
                    
                    {/* Budget Update Modal */}
                    {modal === 'budgetUpdate' && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 animate-up shadow-2xl">
                                <h3 className="font-bold text-xl dark:text-white mb-4">Update Monthly Budget</h3>
                                <input
                                    type="number"
                                    className="input-field text-center text-2xl"
                                    value={budget}
                                    onChange={e => setBudget(e.target.value)}
                                    placeholder="Enter new budget"
                                />
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => {
                                            localStorage.setItem('fm_budget', budget);
                                            setBudgetWarning(false);
                                            setModal(null);
                                        }}
                                        className={`flex-1 py-3 rounded-xl text-white font-bold ${THEMES[theme].class}`}
                                    >
                                        Update
                                    </button>
                                    <button 
                                        onClick={() => setModal(null)}
                                        className="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced Auth Component
        function EnhancedAuth({ onLogin }) { 
            const [view, setView] = useState('login'); 
            const [form, setForm] = useState({ email: '', password: '', username: '', phone: '' }); 
            const [loading, setLoading] = useState(false); 
            const [message, setMessage] = useState(null); 
            
            const submit = async (e) => { 
                e.preventDefault(); 
                setLoading(true); 
                setMessage(null); 
                
                try {
                    if (view === 'login') {
                        const result = await api.login(form.email, form.password);
                        if (result.success && result.data && result.data.user) {
                            setMessage({type:'success', text:'Login successful!'});
                            setTimeout(() => {
                                onLogin(result.data.user);
                            }, 1000);
                        } else {
                            setMessage({type:'error', text:result.error || 'Invalid credentials'});
                        }
                    } else {
                        // Validate signup
                        if (!validatePassword(form.password)) {
                            setMessage({type:'error', text:'Password must be at least 6 characters'});
                            setLoading(false);
                            return;
                        }
                        
                        if (form.phone && !validatePhone(form.phone)) {
                            setMessage({type:'error', text:'Invalid phone number'});
                            setLoading(false);
                            return;
                        }
                        
                        const result = await api.signup({
                            name: form.username,
                            email: form.email,
                            password: form.password,
                            phone: form.phone
                        });
                        
                        if (result.success) {
                            setMessage({type:'success', text:'Account created successfully! Please login.'});
                            setView('login');
                            setForm({ email: form.email, password: '', username: '', phone: '' });
                        } else {
                            setMessage({type:'error', text:result.error || 'Signup failed'});
                        }
                    }
                } catch (error) {
                    console.error('Login/Signup error:', error);
                    setMessage({type:'error', text:'Network error. Please try again.'});
                } finally {
                    setLoading(false);
                }
            }; 
            
            return (
                <div className="h-full flex items-center justify-center p-6 bg-slate-100 dark:bg-slate-900">
                    <div className="w-full max-w-sm bg-white dark:bg-slate-950 p-8 rounded-[2rem] shadow-2xl animate-up">
                        <h1 className="text-3xl font-bold text-center mb-2">FinanceMax</h1>
                        <p className="text-slate-500 text-center mb-6">Track expenses, split bills, manage friends</p>
                        
                        {message && (
                            <div className={`p-3 rounded-xl text-center text-sm mb-4 font-bold ${message.type==='error'?'bg-red-50 text-red-500':'bg-emerald-50 text-emerald-600'}`}>
                                {message.text}
                            </div>
                        )}
                        
                        <form onSubmit={submit} className="space-y-4 mt-6">
                            {view==='signup' && (
                                <input 
                                    className="input-field" 
                                    placeholder="Full Name" 
                                    value={form.username} 
                                    onChange={e=>setForm({...form, username:e.target.value})} 
                                    required 
                                />
                            )}
                            
                            <input 
                                className="input-field" 
                                placeholder="Email" 
                                type="email" 
                                value={form.email} 
                                onChange={e=>setForm({...form, email:e.target.value})} 
                                required 
                            />
                            
                            {view==='signup' && (
                                <input 
                                    className="input-field" 
                                    placeholder="Phone (Optional)" 
                                    type="tel"
                                    value={form.phone} 
                                    onChange={e=>setForm({...form, phone:e.target.value})} 
                                />
                            )}
                            
                            <input 
                                type="password" 
                                className="input-field" 
                                placeholder="Password" 
                                value={form.password} 
                                onChange={e=>setForm({...form, password:e.target.value})} 
                                required 
                            />
                            
                            {view==='signup' && (
                                <p className="text-xs text-slate-500">Password must be at least 6 characters long</p>
                            )}
                            
                            <button disabled={loading} className="btn-primary bg-indigo-600 shadow-xl shadow-indigo-500/30">
                                {loading ? (
                                    <div className="loader mx-auto"></div>
                                ) : view==='login' ? 'Login' : 'Sign Up'}
                            </button>
                        </form>
                        
                        <button onClick={()=>setView(view==='login'?'signup':'login')} className="w-full mt-6 text-sm text-slate-400 hover:text-indigo-500">
                            {view==='login' ? "Don't have an account? Sign Up" : 'Already have an account? Login'}
                        </button>
                    </div>
                </div>
            ); 
        }

        // Main App Component
        function App() { 
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('fm_plat_user');
                return saved ? JSON.parse(saved) : null;
            }); 
            
            const handleLogin = (userData) => { 
                setUser(userData); 
                localStorage.setItem('fm_plat_user', JSON.stringify(userData)); 
            }; 
            
            const handleLogout = () => { 
                setUser(null); 
                localStorage.removeItem('fm_plat_user'); 
                localStorage.removeItem('fm_budget');
                localStorage.removeItem('fm_theme');
                localStorage.removeItem('fm_accent');
            }; 
            
            return user ? <EnhancedDashboard user={user} onLogout={handleLogout} /> : <EnhancedAuth onLogin={handleLogin} />; 
        }

        // Global Responsive Styles
        const globalResponsiveStyles = `
            .modal-inner { border-radius: 1.25rem; padding: 1.25rem; }
            .confirm-buttons { display: flex; gap: .75rem; }
            @media (max-width: 520px) {
                .modal-inner { padding: .9rem; border-radius: 1rem; max-width: 94%; }
                .confirm-buttons.stack-on-mobile { flex-direction: column; }
            }
            .wrap-break { white-space: pre-wrap; word-break: break-word; }
            .status-icon-inline { display:inline-flex; width:1.5rem; height:1.5rem; min-width:1.5rem; align-items:center; justify-content:center; border-radius:9999px; }
            .status-icon-small { display:inline-flex; width:1rem; height:1rem; min-width:1rem; align-items:center; justify-content:center; border-radius:9999px; }
            .scroll-x { overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; -ms-overflow-style: none; scrollbar-width: none; padding-bottom: 6px; }
            .scroll-x::-webkit-scrollbar { display: none; height: 0; }
            .scroll-x > * { display: inline-flex; }
            .theme-swatches { display:flex; gap:.5rem; align-items:center; }
            .swatch { box-sizing: border-box; flex-shrink:0; }
            .theme-row { gap: .75rem; }
            @media (max-width:520px) { .theme-swatches { gap:.5rem; } }
        `;
        
        // Add global styles
        if (!document.getElementById('fm-responsive-styles')) {
            const s = document.createElement('style');
            s.id = 'fm-responsive-styles';
            s.innerText = globalResponsiveStyles;
            document.head.appendChild(s);
        }

        // Initialize lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
